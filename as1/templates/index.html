{% load socialaccount %}
{% load account %}
{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Circuit Generator | ØªÙˆÙ„ÛŒØ¯ Ù…Ø¯Ø§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  </head>
  <body>
    <div class="app-container{% if not user.is_authenticated %} login-page{% endif %}">
      {% if user.is_authenticated %}
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <div class="logo-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.1 -0.1 20.2 10.2" width="32" height="16">
                <defs>
                  <linearGradient id="sidebarCircuitGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0" />
                    <stop offset="50%" style="stop-color:#ffffff;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0" />
                  </linearGradient>
                </defs>
                <!-- Background static circuit -->
                <path d="M0 5 4 5Q5 5 5 4L5 1Q5 0 6 0L9 0Q10 0 10 1L10 9Q10 10 11 10L14 10Q15 10 15 9L15 6Q15 5 16 5L20 5"
                      stroke="rgba(255, 255, 255, 0.4)"
                      stroke-width="0.15"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round" />
                <!-- Animated flowing circuit -->
                <path d="M0 5 4 5Q5 5 5 4L5 1Q5 0 6 0L9 0Q10 0 10 1L10 9Q10 10 11 10L14 10Q15 10 15 9L15 6Q15 5 16 5L20 5"
                      stroke="url(#sidebarCircuitGradient)"
                      stroke-width="0.3"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-dasharray="1,2"
                      pathLength="100">
                  <animate attributeName="stroke-dashoffset"
                           values="0;-20"
                           dur="1.5s"
                           repeatCount="indefinite" />
                  <animate attributeName="stroke-width"
                           values="0.3;0.4;0.3"
                           dur="2s"
                           repeatCount="indefinite" />
                </path>
              </svg>
            </div>
            <h2 data-lang-key="circuit-ai">Circuit AI</h2>
          </div>
          <div class="sidebar-header-actions">
            <div class="language-toggle">
              <div class="lang-toggle" data-lang="en">
                <div class="lang-slider">EN</div>
                <span class="lang-text en">EN</span>
                <span class="lang-text fa">FA</span>
              </div>
            </div>
            <button id="btnToggleSettings" class="btn-glass btn-icon" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-settings-2"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.875 6.27a2.225 2.225 0 0 1 1.125 1.948v7.284c0 .809 -.443 1.555 -1.158 1.948l-6.75 4.27a2.269 2.269 0 0 1 -2.184 0l-6.75 -4.27a2.225 2.225 0 0 1 -1.158 -1.948v-7.285c0 -.809 .443 -1.554 1.158 -1.947l6.75 -3.98a2.33 2.33 0 0 1 2.25 0l6.75 3.98h-.033z" /><path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /></svg>
            </button>
            <button id="btnNewChat" class="btn-glass btn-icon" title="Ú†Øª Ø¬Ø¯ÛŒØ¯">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-square-rounded-plus"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 2l.324 .001l.318 .004l.616 .017l.299 .013l.579 .034l.553 .046c4.785 .464 6.732 2.411 7.196 7.196l.046 .553l.034 .579c.005 .098 .01 .198 .013 .299l.017 .616l.005 .642l-.005 .642l-.017 .616l-.013 .299l-.034 .579l-.046 .553c-.464 4.785 -2.411 6.732 -7.196 7.196l-.553 .046l-.579 .034c-.098 .005 -.198 .01 -.299 .013l-.616 .017l-.642 .005l-.642 -.005l-.616 -.017l-.299 -.013l-.579 -.034l-.553 -.046c-4.785 -.464 -6.732 -2.411 -7.196 -7.196l-.046 -.553l-.034 -.579a28.058 28.058 0 0 1 -.013 -.299l-.017 -.616c-.003 -.21 -.005 -.424 -.005 -.642l.001 -.324l.004 -.318l.017 -.616l.013 -.299l.034 -.579l.046 -.553c.464 -4.785 2.411 -6.732 7.196 -7.196l.553 -.046l.579 -.034c.098 -.005 .198 -.01 .299 -.013l.616 -.017c.21 -.003 .424 -.005 .642 -.005zm0 6a1 1 0 0 0 -1 1v2h-2l-.117 .007a1 1 0 0 0 .117 1.993h2v2l.007 .117a1 1 0 0 0 1.993 -.117v-2h2l.117 -.007a1 1 0 0 0 -.117 -1.993h-2v-2l-.007 -.117a1 1 0 0 0 -.993 -.883z" fill="currentColor" stroke-width="0" /></svg>
            </button>
          </div>
        </div>

        <div class="sidebar-content">
          <div id="sidebarContentWrapper" class="sidebar-content-wrapper">
            <div id="settingsSection" class="settings-section">
              <h3 class="section-title" data-lang-key="settings">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
              <div class="form-group">
                <label for="llmBaseUrl" data-lang-key="base-url">Base URL</label>
                <input id="llmBaseUrl" type="text" class="input-glass" value="http://127.0.0.1:1234" placeholder="http://127.0.0.1:1234" />
              </div>
              <div class="form-group">
                <label for="llmModel" data-lang-key="model-name">Ù†Ø§Ù… Ù…Ø¯Ù„</label>
                <input id="llmModel" type="text" class="input-glass" value="grok-3-reasoning-gemma3-4b-distilled-hf" placeholder="Ù†Ø§Ù… Ù…Ø¯Ù„" />
              </div>
              <div class="form-group">
                <label for="llmApiKey" data-lang-key="api-key">API Key</label>
                <input id="llmApiKey" type="password" class="input-glass" placeholder="sk-... ÛŒØ§ API Key Ù…Ø­Ù„ÛŒ" />
                <small class="input-hint" data-lang-key="api-key-hint">Ø¨Ø±Ø§ÛŒ OpenAI Ø¨Ø§ sk- Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯</small>
              </div>
              <div class="form-group">
                <label data-lang-key="user">Ú©Ø§Ø±Ø¨Ø±:</label>
                <p>{{ user.username }}</p>
                <form action="{% url 'logout' %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-glass" style="margin-top: 10px;" data-lang-key="logout">Ø®Ø±ÙˆØ¬</button>
                </form>
              </div>
            </div>

            <div id="historySection" class="history-section active">
              <h3 class="section-title" data-lang-key="history">ØªØ§Ø±ÛŒØ®Ú†Ù‡</h3>
              <div id="chatSessions" class="chat-sessions">
                <div class="session-item active" data-session="default">
                  <span class="session-name" contenteditable="false">Ú†Øª Ø¬Ø¯ÛŒØ¯</span>
                  <div class="session-actions">
                    <button class="btn-edit-session" data-session="default" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="btn-delete-session" data-session="default" title="Ø­Ø°Ù">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Chat Area -->
      <main class="chat-main">
        <div class="chat-header">
          <div class="header-left">
            <button id="btnToggleSidebar" class="btn-glass btn-icon" title="Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù…Ù†Ùˆ">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <div class="header-title">
              <h1 id="chatSessionTitle" data-lang-key="new-chat">Ú†Øª Ø¬Ø¯ÛŒØ¯</h1>
              <p class="header-subtitle" data-lang-key="design-circuit-ai">Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ú©Ù†ÛŒØ¯</p>
            </div>
          </div>
          <div class="header-actions">
            <button id="btnClearChat" class="btn-glass btn-icon chat-only" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>

        <div id="chatMessages" class="chat-messages">
          <div class="welcome-message">
            <div class="welcome-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.1 -0.1 20.2 10.2" width="64" height="32">
                <defs>
                  <linearGradient id="welcomeCircuitGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0" />
                    <stop offset="50%" style="stop-color:#ffffff;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0" />
                  </linearGradient>
                </defs>
                <path d="M0 5 4 5Q5 5 5 4L5 1Q5 0 6 0L9 0Q10 0 10 1L10 9Q10 10 11 10L14 10Q15 10 15 9L15 6Q15 5 16 5L20 5"
                      stroke="url(#welcomeCircuitGradient)"
                      stroke-width="0.4"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-dasharray="2,3"
                      pathLength="100">
                  <animate attributeName="stroke-dashoffset"
                           values="0;-25"
                           dur="1.8s"
                           repeatCount="indefinite" />
                </path>
              </svg>
            </div>
            <h2 data-lang-key="welcome">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
            <p data-lang-key="welcome-description">ØªÙˆØ¶ÛŒØ­ Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ú©Ø¯ Ùˆ ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø± Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù….</p>
            <div class="example-prompts">
              <div class="example-prompt glass-card" data-prompt="ÛŒÚ© ÙÛŒÙ„ØªØ± RC Ù¾Ø§ÛŒÛŒÙ†â€ŒÚ¯Ø°Ø± Ø¨Ø§ Ù…Ù‚Ø§ÙˆÙ…Øª 10k Ùˆ Ø®Ø§Ø²Ù† 10nF">
                <span data-lang-key="rc-low-pass-filter">ÙÛŒÙ„ØªØ± RC Ù¾Ø§ÛŒÛŒÙ†â€ŒÚ¯Ø°Ø±</span>
              </div>
              <div class="example-prompt glass-card" data-prompt="ÛŒÚ© ØªÙ‚ÙˆÛŒØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø§ ÙÛŒØ¯Ø¨Ú© Ù…Ù†ÙÛŒ">
                <span data-lang-key="op-amp">ØªÙ‚ÙˆÛŒØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</span>
              </div>
              <div class="example-prompt glass-card" data-prompt="ÛŒÚ© Ù…Ø¯Ø§Ø± Ù†ÙˆØ³Ø§Ù†â€ŒØ³Ø§Ø² RC">
                <span data-lang-key="rc-oscillator">Ù†ÙˆØ³Ø§Ù†â€ŒØ³Ø§Ø² RC</span>
              </div>
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="input-wrapper glass-card">
            <textarea
              id="chatInput"
              placeholder="ØªÙˆØ¶ÛŒØ­ Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
              rows="1"
            ></textarea>
            <button id="btnSend" class="btn-send" title="Ø§Ø±Ø³Ø§Ù„">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        </div>
      </main>
      {% else %}
      <div class="login-container">
        <div class="login-form">
          <div class="logo">
            <div class="logo-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.1 -0.1 20.2 10.2" width="32" height="16">
                <defs>
                  <linearGradient id="loginCircuitGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0" />
                    <stop offset="50%" style="stop-color:#ffffff;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0" />
                  </linearGradient>
                </defs>
                <path d="M0 5 4 5Q5 5 5 4L5 1Q5 0 6 0L9 0Q10 0 10 1L10 9Q10 10 11 10L14 10Q15 10 15 9L15 6Q15 5 16 5L20 5"
                      stroke="url(#loginCircuitGradient)"
                      stroke-width="0.3"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-dasharray="1,2"
                      pathLength="100">
                  <animate attributeName="stroke-dashoffset"
                           values="0;-20"
                           dur="1.5s"
                           repeatCount="indefinite" />
                </path>
              </svg>
            </div>
            <h2 class="login-title" data-lang-key="circuit-ai">Circuit AI</h2>
          </div>
          <p class="header-subtitle" style="color: var(--white-60); font-size: 14px; margin-bottom: 30px; text-align: center;" data-lang-key="design-circuit-ai">Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ú©Ù†ÛŒØ¯</p>

          {% if signup_form %}
            <!-- Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ú¯ÙˆÚ¯Ù„ -->
            <a href="{% provider_login_url 'google' %}" class="google-signup-btn" data-lang-key="signup-with-google">
              <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ú¯ÙˆÚ¯Ù„
            </a>

            <div class="divider">
              <span data-lang-key="or">ÛŒØ§</span>
            </div>

            <form method="post" action="{% url 'signup' %}">
                {% csrf_token %}
                <div class="form-group">
                  <label for="{{ signup_form.username.id_for_label }}" data-lang-key="username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                  <input type="text" name="username" id="{{ signup_form.username.id_for_label }}" class="input-glass" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
                </div>
                <div class="form-group">
                  <label for="{{ signup_form.email.id_for_label }}" data-lang-key="email">Ø§ÛŒÙ…ÛŒÙ„</label>
                  <input type="email" name="email" id="{{ signup_form.email.id_for_label }}" class="input-glass" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
                </div>
                <div class="form-group">
                  <label for="{{ signup_form.password1.id_for_label }}" data-lang-key="password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                  <input type="password" name="password1" id="{{ signup_form.password1.id_for_label }}" class="input-glass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
                </div>
                <div class="form-group">
                  <label for="{{ signup_form.password2.id_for_label }}" data-lang-key="confirm-password">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                  <input type="password" name="password2" id="{{ signup_form.password2.id_for_label }}" class="input-glass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ØªÚ©Ø±Ø§Ø± Ú©Ù†ÛŒØ¯" required>
                </div>
                <button type="submit" class="login-button" data-lang-key="signup">Ø«Ø¨Øª Ù†Ø§Ù…</button>
            </form>
            <div class="login-links">
              <span data-lang-key="have-account">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ</span>
              <a href="#" id="showLogin" data-lang-key="login">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
            </div>
          {% elif login_form %}
            <!-- Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„ -->
            <a href="{% provider_login_url 'google' %}" class="google-signup-btn" data-lang-key="login-with-google">
              <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„
            </a>

            <div class="divider">
              <span data-lang-key="or">ÛŒØ§</span>
            </div>

            <form method="post" action="{% url 'login' %}">
                {% csrf_token %}
                <div class="form-group">
                  <label for="{{ login_form.username.id_for_label }}" data-lang-key="username-or-email">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„</label>
                  <input type="text" name="username" id="{{ login_form.username.id_for_label }}" class="input-glass" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
                </div>
                <div class="form-group">
                  <label for="{{ login_form.password.id_for_label }}" data-lang-key="password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                  <input type="password" name="password" id="{{ login_form.password.id_for_label }}" class="input-glass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required>
                </div>
                {% if error_message %}
                    <p class="error-message">{{ error_message }}</p>
                {% endif %}
                <button type="submit" class="login-button" data-lang-key="login">ÙˆØ±ÙˆØ¯</button>
            </form>
            <div class="login-links">
              <span data-lang-key="no-account">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ</span>
              <a href="#" id="showSignup" data-lang-key="signup-link">Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</a>
            </div>
          {% else %}
            <p style="color: var(--white-60); font-size: 16px; margin-bottom: 30px; text-align: center;" data-lang-key="please-login-signup">Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ÛŒØ§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ù‡ Ú†Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.</p>
            <button id="mainShowLogin" class="login-button" style="margin-bottom: 15px;" data-lang-key="login">ÙˆØ±ÙˆØ¯</button>
            <button id="mainShowSignup" class="login-button" data-lang-key="signup">Ø«Ø¨Øª Ù†Ø§Ù…</button>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script>
      // Language translations
      const translations = {
        en: {
          'circuit-ai': 'Circuit AI',
          'settings': 'Settings',
          'base-url': 'Base URL',
          'model-name': 'Model Name',
          'api-key': 'API Key',
          'api-key-hint': 'Starts with sk- for OpenAI',
          'user': 'User:',
          'logout': 'Logout',
          'history': 'History',
          'new-chat': 'New Chat',
          'design-circuit-ai': 'Design your circuit with AI',
          'toggle-menu': 'Toggle Menu',
          'clear-chat': 'Clear Chat',
          'welcome': 'Welcome',
          'welcome-description': 'Write your circuit description in Persian and I will generate code and circuit image for you.',
          'rc-low-pass-filter': 'RC Low Pass Filter',
          'op-amp': 'Operational Amplifier',
          'rc-oscillator': 'RC Oscillator',
          'chat-placeholder': 'Describe your circuit...',
          'send': 'Send',
          'signup-with-google': 'Sign up with Google',
          'login-with-google': 'Login with Google',
          'or': 'or',
          'username': 'Username',
          'email': 'Email',
          'password': 'Password',
          'confirm-password': 'Confirm Password',
          'signup': 'Sign Up',
          'have-account': 'Have an account?',
          'login': 'Login',
          'username-or-email': 'Username or Email',
          'no-account': 'Don\'t have an account?',
          'signup-link': 'Sign up',
          'please-login-signup': 'Please login or sign up to access the chat.'
        },
        fa: {
          'circuit-ai': 'Circuit AI',
          'settings': 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª',
          'base-url': 'Base URL',
          'model-name': 'Ù†Ø§Ù… Ù…Ø¯Ù„',
          'api-key': 'API Key',
          'api-key-hint': 'Ø¨Ø±Ø§ÛŒ OpenAI Ø¨Ø§ sk- Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯',
          'user': 'Ú©Ø§Ø±Ø¨Ø±:',
          'logout': 'Ø®Ø±ÙˆØ¬',
          'history': 'ØªØ§Ø±ÛŒØ®Ú†Ù‡',
          'new-chat': 'Ú†Øª Ø¬Ø¯ÛŒØ¯',
          'design-circuit-ai': 'Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ú©Ù†ÛŒØ¯',
          'toggle-menu': 'Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù…Ù†Ùˆ',
          'clear-chat': 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª',
          'welcome': 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯',
          'welcome-description': 'ØªÙˆØ¶ÛŒØ­ Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ú©Ø¯ Ùˆ ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø± Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù….',
          'rc-low-pass-filter': 'ÙÛŒÙ„ØªØ± RC Ù¾Ø§ÛŒÛŒÙ†â€ŒÚ¯Ø°Ø±',
          'op-amp': 'ØªÙ‚ÙˆÛŒØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ',
          'rc-oscillator': 'Ù†ÙˆØ³Ø§Ù†â€ŒØ³Ø§Ø² RC',
          'chat-placeholder': 'ØªÙˆØ¶ÛŒØ­ Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...',
          'send': 'Ø§Ø±Ø³Ø§Ù„',
          'signup-with-google': 'Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ú¯ÙˆÚ¯Ù„',
          'login-with-google': 'ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„',
          'or': 'ÛŒØ§',
          'username': 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ',
          'email': 'Ø§ÛŒÙ…ÛŒÙ„',
          'password': 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
          'confirm-password': 'ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
          'signup': 'Ø«Ø¨Øª Ù†Ø§Ù…',
          'have-account': 'Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ',
          'login': 'ÙˆØ±ÙˆØ¯',
          'username-or-email': 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„',
          'no-account': 'Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ',
          'signup-link': 'Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯',
          'please-login-signup': 'Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ÛŒØ§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ù‡ Ú†Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.'
        }
      };

      // Current language (default: English to match landing page)
      let currentLang = 'en';

      // Language switch function
      function switchLanguage(lang) {
        currentLang = lang;

        // Update all elements with data-lang-key
        document.querySelectorAll('[data-lang-key]').forEach(element => {
          const key = element.getAttribute('data-lang-key');
          if (translations[lang][key]) {
            if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
              element.placeholder = translations[lang][key];
            } else {
              element.textContent = translations[lang][key];
            }
          }
        });

        // Update language toggle
        const langToggle = document.querySelector('.lang-toggle');
        if (langToggle) {
          langToggle.setAttribute('data-lang', lang);
        }

        // Update document direction
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';

        // Save language preference
        localStorage.setItem('circuit-ai-lang', lang);
      }

      // Utility functions
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// State
let currentSessionId = 'default';
let isLoading = false;

// Elements
const chatMessages = $('#chatMessages');
const chatInput = $('#chatInput');
const btnSend = $('#btnSend');
const btnNewChat = $('#btnNewChat');
const btnClearChat = $('#btnClearChat');
const btnToggleSidebar = $('#btnToggleSidebar');
const statusMessage = $('#statusMessage'); // Might be deprecated
const chatSessions = $('#chatSessions');
const sidebar = $('.sidebar');
const llmBaseUrl = $('#llmBaseUrl');
const llmModel = $('#llmModel');
const llmApiKey = $('#llmApiKey');
const chatSessionTitle = $('#chatSessionTitle');
const btnToggleSettings = $('#btnToggleSettings');
const settingsSection = $('#settingsSection');
const historySection = $('#historySection');
const sidebarContentWrapper = $('#sidebarContentWrapper');

// Auth elements (new)
const authMain = $('.auth-main'); // The main container for auth forms
const mainShowLoginBtn = $('#mainShowLogin');
const mainShowSignupBtn = $('#mainShowSignup');
const showLoginLink = $('#showLogin');
const showSignupLink = $('#showSignup');


// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Load saved language preference or default to English (matching landing page)
  const savedLang = localStorage.getItem('circuit-ai-lang') || 'en';
  switchLanguage(savedLang);

  // Add click handler to language toggle
  const langToggle = document.querySelector('.lang-toggle');
  if (langToggle) {
    langToggle.addEventListener('click', function() {
      const currentLang = this.getAttribute('data-lang');
      const newLang = currentLang === 'en' ? 'fa' : 'en';
      this.setAttribute('data-lang', newLang);
      switchLanguage(newLang);
    });
  }

  // Only load chat specific functions if user is authenticated (chatMessages element exists)
  if (chatMessages) {
    loadChatSessions();
    loadChatHistory(currentSessionId);
    setupChatEventListeners(); // Separate chat event listeners
    autoResizeTextarea();
    loadSidebarState();
    // Close sidebar on outside click
    document.addEventListener('click', (e) => {
      if (sidebar && !sidebar.contains(e.target) && !btnToggleSidebar.contains(e.target) && !sidebar.classList.contains('collapsed')) {
        sidebar.classList.add('collapsed');
        localStorage.setItem('sidebarCollapsed', 'true');
      }
    });
    // Update chat session title on load
    updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯');
  }
  setupAuthEventListeners(); // Always setup auth event listeners
});

// Auth Event Listeners
function setupAuthEventListeners() {
  // Handle main login/signup buttons
  if (mainShowLoginBtn) {
    mainShowLoginBtn.addEventListener('click', () => {
      window.location.href = '/login/?show_login=true';
    });
  }
  if (mainShowSignupBtn) {
    mainShowSignupBtn.addEventListener('click', () => {
      window.location.href = '/signup/?show_signup=true';
    });
  }

  // Handle "Already have an account?" / "Don't have an account?" links
  if (showLoginLink) {
    showLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = '/login/?show_login=true'; // Redirect to login page with query param
    });
  }
  if (showSignupLink) {
    showSignupLink.addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = '/signup/?show_signup=true'; // Redirect to signup page with query param
    });
  }
}

// Chat Event Listeners
function setupChatEventListeners() {
  btnSend.addEventListener('click', sendMessage);
  btnNewChat.addEventListener('click', createNewChat);
  btnClearChat.addEventListener('click', clearCurrentChat);
  btnToggleSidebar.addEventListener('click', toggleSidebar);
  btnToggleSettings.addEventListener('click', toggleSettingsHistory);
  
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Example prompts
  $$('.example-prompt').forEach(prompt => {
    prompt.addEventListener('click', () => {
      const text = prompt.getAttribute('data-prompt');
      chatInput.value = text;
      chatInput.focus();
    });
  });

  // Session click handlers
  chatSessions.addEventListener('click', (e) => {
    const sessionItem = e.target.closest('.session-item');
    if (sessionItem) {
      const sessionId = sessionItem.getAttribute('data-session');
      if (sessionId && sessionId !== currentSessionId) {
        switchSession(sessionId);
      }
    }

    const deleteBtn = e.target.closest('.btn-delete-session');
    if (deleteBtn) {
      e.stopPropagation();
      const sessionId = deleteBtn.getAttribute('data-session');
      if (sessionId) { // Allow deleting default session to clear history
        deleteSession(sessionId);
      }
    }

    const editBtn = e.target.closest('.btn-edit-session');
    if (editBtn) {
      e.stopPropagation();
      const sessionId = editBtn.getAttribute('data-session');
      editSessionName(sessionId);
    }
  });
}

// Auto-resize textarea
function autoResizeTextarea() {
  if (!chatInput) return;
  chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
  });
}

// Send Message
async function sendMessage() {
  const message = chatInput.value.trim();
  if (!message || isLoading) return;

  // Clear input
  chatInput.value = '';
  chatInput.style.height = 'auto';
  
  // Hide welcome message
  const welcomeMsg = $('.welcome-message');
  if (welcomeMsg) {
    welcomeMsg.remove();
  }

  // Add user message
  addMessage('user', message);

  // Show loading
  const loadingId = addLoadingMessage();
  setStatus('Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ù…Ø¯Ø§Ø±...', '');
  btnSend.disabled = true;
  isLoading = true;

  try {
    const response = await fetch('/api/chat/message', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken // Include CSRF token
      },
      body: JSON.stringify({
        message,
        sessionId: currentSessionId,
        llmBaseUrl: llmBaseUrl ? llmBaseUrl.value.trim() : '',
        llmModel: llmModel ? llmModel.value.trim() : '',
        llmApiKey: llmApiKey ? llmApiKey.value.trim() : ''
      })
    });

    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ');
    }

    // Remove loading
    removeMessage(loadingId);

    // Add assistant message
    addAssistantMessage({ content: data.message }); // API now returns a message object
    // Collapse sidebar after successful assistant response
    if (sidebar && !sidebar.classList.contains('collapsed')) {
      sidebar.classList.add('collapsed');
      localStorage.setItem('sidebarCollapsed', 'true');
    }
    setStatus('', '');
    
    // Reload sessions to update last message time
    loadChatSessions();
  } catch (error) {
    removeMessage(loadingId);
    addMessage('assistant', `Ø®Ø·Ø§: ${error.message}`, true);
    showToast(`Ø®Ø·Ø§: ${error.message}`, 'error');
  } finally {
    btnSend.disabled = false;
    isLoading = false;
    chatInput.focus();
  }
}

// Add Message
function addMessage(role, content, isError = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.innerHTML = role === 'user' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><path d="M22 17H2a4 4 0 0 1 4-4h12a4 4 0 0 1 4 4v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z"/><path d="M2 17a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2"/></svg>';
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  
  if (isError) {
    bubble.style.background = 'var(--error)';
    bubble.style.color = 'white';
  }
  
  bubble.textContent = content;

  // Add copy button for user messages
  if (role === 'user') {
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn-copy-message';
    copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1-1.1-2-2.5-2-4 0-1.5 1.1-3 2.5-4.5S7 2 8.5 2C10 2 11.4 1.1 12 2.5"/></svg>';
    copyBtn.title = 'Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…';
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(content).then(() => {
        showToast('Ù¾ÛŒØ§Ù… Ú©Ù¾ÛŒ Ø´Ø¯!', 'success', 2000);
      }).catch(err => {
        console.error('Failed to copy message: ', err);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ù¾ÛŒØ§Ù…', 'error', 2000);
      });
    });
    messageContent.appendChild(copyBtn);
  }
  
  messageContent.appendChild(bubble);
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(messageContent);
  
  if (chatMessages) {
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }
  
  return messageDiv;
}

// Add Assistant Message with full output
function addAssistantMessage(messageData) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message assistant';

  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><path d="M22 17H2a4 4 0 0 1 4-4h12a4 4 0 0 1 4 4v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z"/><path d="M2 17a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2"/></svg>';

  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';

  const assistantOutput = document.createElement('div');
  assistantOutput.className = 'assistant-output';

  const content = messageData.content || {}; // Use empty object if null

  // 1. Model Output (collapsible)
  if (content && content.modelOutput) {
    const { section: modelSection, contentDiv: modelContentDiv } = createOutputSection('1ï¸âƒ£ Ø®Ø±ÙˆØ¬ÛŒ Ù…Ø¯Ù„', 'model', true, true);
    const modelContent = document.createElement('div');
    modelContent.className = 'output-text';
    modelContent.textContent = content.modelOutput;
    modelContentDiv.appendChild(modelContent);
    assistantOutput.appendChild(modelSection);
  }

  // 2. Python Code (collapsible)
  if (content.pythonCode) {
    const { section: pythonSection, contentDiv: pythonContentDiv } = createOutputSection('ğŸ Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ†', 'python', true, true);
    const pythonContent = document.createElement('div');
    pythonContent.className = 'output-code';
    const pre = document.createElement('pre');
    pre.textContent = content.pythonCode;
    pythonContent.appendChild(pre);

    // Copy button for Python code
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn-copy-code';
    copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1-1.1-2-2.5-2-4 0-1.5 1.1-3 2.5-4.5S7 2 8.5 2C10 2 11.4 1.1 12 2.5"/></svg>';
    copyBtn.title = 'Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ú©Ø¯';
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(content.pythonCode).then(() => {
        showToast('Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† Ú©Ù¾ÛŒ Ø´Ø¯!', 'success', 2000);
      }).catch(err => {
        console.error('Failed to copy Python code: ', err);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ†', 'error', 2000);
      });
    });
    pythonContent.appendChild(copyBtn);

    pythonContentDiv.appendChild(pythonContent);
    assistantOutput.appendChild(pythonSection);
  }

  // 3. SPICE Code (collapsible)
  if (content.spiceCode) {
    const { section: spiceSection, contentDiv: spiceContentDiv } = createOutputSection('ğŸ”Œ Ú©Ø¯ SPICE', 'spice', true, true);
    const spiceContent = document.createElement('div');
    spiceContent.className = 'output-code';
    const pre = document.createElement('pre');
    pre.textContent = content.spiceCode;
    spiceContent.appendChild(pre);

    // Copy button for SPICE code
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn-copy-code';
    copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1-1.1-2-2.5-2-4 0-1.5 1.1-3 2.5-4.5S7 2 8.5 2C10 2 11.4 1.1 12 2.5"/></svg>';
    copyBtn.title = 'Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ú©Ø¯';
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(content.spiceCode).then(() => {
        showToast('Ú©Ø¯ SPICE Ú©Ù¾ÛŒ Ø´Ø¯!', 'success', 2000);
      }).catch(err => {
        console.error('Failed to copy SPICE code: ', err);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø¯ SPICE', 'error', 2000);
      });
    });
    spiceContent.appendChild(copyBtn);

    spiceContentDiv.appendChild(spiceContent);
    assistantOutput.appendChild(spiceSection);
  }

  // 4. Components List (collapsible)
  if (content.components && Array.isArray(content.components) && content.components.length > 0) {
    const { section: componentsSection, contentDiv: componentsContentDiv } = createOutputSection('ğŸ“‹ Ù„ÛŒØ³Øª Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø§Ø±', 'components', true, true);
    const componentsContent = document.createElement('div');
    componentsContent.className = 'output-code';
    const pre = document.createElement('pre');
    pre.textContent = JSON.stringify(content.components, null, 2);
    componentsContent.appendChild(pre);

    // Copy button for components
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn-copy-code';
    copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1-1.1-2-2.5-2-4 0-1.5 1.1-3 2.5-4.5S7 2 8.5 2C10 2 11.4 1.1 12 2.5"/></svg>';
    copyBtn.title = 'Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª';
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(JSON.stringify(content.components, null, 2)).then(() => {
        showToast('Ù„ÛŒØ³Øª Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ Ú©Ù¾ÛŒ Ø´Ø¯!', 'success', 2000);
      }).catch(err => {
        console.error('Failed to copy components: ', err);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ù„ÛŒØ³Øª Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§', 'error', 2000);
      });
    });
    componentsContent.appendChild(copyBtn);

    componentsContentDiv.appendChild(componentsContent);
    assistantOutput.appendChild(componentsSection);
  }

  // Legacy support for elements list (might be removed later)
  if (content.elements) {
    const { section: elementsSection, contentDiv: elementsContentDiv } = createOutputSection('ğŸ“‹ Ù„ÛŒØ³Øª Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø§Ø± (Ù‚Ø¯ÛŒÙ…ÛŒ)', 'elements', true, true);
    const elementsContent = document.createElement('div');
    elementsContent.className = 'output-code';
    const pre = document.createElement('pre');
    pre.textContent = JSON.stringify(content.elements, null, 2);
    elementsContent.appendChild(pre);
    elementsContentDiv.appendChild(elementsContent);
    assistantOutput.appendChild(elementsSection);
  }

  // Legacy support for code (might be removed later)
  if (content.code) {
    const { section: codeSection, contentDiv: codeContentDiv } = createOutputSection('ğŸ’» Ú©Ø¯ ØªÙˆÙ„ÛŒØ¯ÛŒ (Ù‚Ø¯ÛŒÙ…ÛŒ)', 'code', true, true);
    const codeContent = document.createElement('div');
    codeContent.className = 'output-code';
    const pre = document.createElement('pre');
    pre.textContent = content.code;
    codeContent.appendChild(pre);
    codeContentDiv.appendChild(codeContent);
    assistantOutput.appendChild(codeSection);
  }

  // 5. Image - Ø±Ù†Ø¯Ø± Ø´Ø¯Ù‡ Ø§Ø² Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ†
  // Ø§Ú¯Ø± ØªØµÙˆÛŒØ± Ø§Ø² Ù‚Ø¨Ù„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
  if (content.imageBase64 && content.imageBase64 !== "data:image/png;base64,") {
    displayImage(content.imageBase64, assistantOutput);
  }
  // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø§Ú¯Ø± Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ ØªØµÙˆÛŒØ± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†
  else if (content.pythonCode) {
    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ú©Ø¯
    fetch('/api/chat/render-code/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ python_code: content.pythonCode })
    })
    .then(response => response.json())
    .then(data => {
      if (data.image_base64) {
        displayImage(data.image_base64, assistantOutput);
      } else {
        // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±ØŒ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        const { section: imageSection, contentDiv: imageContentDiv } = createOutputSection('ğŸ–¼ï¸ ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø±', 'image', true, false);
        const imageContent = document.createElement('div');
        const errorMsg = document.createElement('div');
        errorMsg.className = 'output-error';
        errorMsg.textContent = 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø±. Ú©Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†Ø§Ø¯Ø±Ø³Øª Ø¨Ø§Ø´Ø¯.';
        errorMsg.style.cssText = 'color: #ff6b6b; padding: 16px; background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; margin: 10px 0;';
        imageContent.appendChild(errorMsg);
        imageContentDiv.appendChild(imageContent);
        assistantOutput.appendChild(imageSection);
      }
    })
    .catch(error => {
      console.error('Error rendering code:', error);
      const { section: imageSection, contentDiv: imageContentDiv } = createOutputSection('ğŸ–¼ï¸ ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø±', 'image', true, false);
      const imageContent = document.createElement('div');
      const errorMsg = document.createElement('div');
      errorMsg.className = 'output-error';
      errorMsg.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±.';
      errorMsg.style.cssText = 'color: #ff6b6b; padding: 16px; background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; margin: 10px 0;';
      imageContent.appendChild(errorMsg);
      imageContentDiv.appendChild(imageContent);
      assistantOutput.appendChild(imageSection);
    });
  }

  // 6. Simulation Button - Ø¯Ú©Ù…Ù‡ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ø§Ø±
  if (content.spiceCode && content.spiceCode.trim()) {
    const { section: simulationSection, contentDiv: simulationContentDiv } = createOutputSection('âš¡ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ø§Ø±', 'simulation', false, false);
    const simulationControlPanel = document.createElement('div');
    simulationControlPanel.className = 'simulation-control-panel';

    const simulateBtn = document.createElement('button');
    simulateBtn.className = 'btn-glass simulate-circuit-btn';
    simulateBtn.textContent = 'Ø´Ø±ÙˆØ¹ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ø§Ø±';
    simulateBtn.addEventListener('click', () => {
      enterCircuitSimulationMode(content);
    });

    const description = document.createElement('p');
    description.textContent = 'Ø§ÛŒÙ† Ù…Ø¯Ø§Ø± Ø±Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ ØªØ­Ù„ÛŒÙ„ Ú©Ù†ÛŒØ¯. Ø´Ø§Ù…Ù„ Ø±Ø³Ù… Ø´Ù…Ø§ØªÛŒÚ©ØŒ Ø§Ø¬Ø±Ø§ÛŒ NgspiceØŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù¾ÛŒØ´Ø±ÙØªÙ‡.';
    description.className = 'simulation-description';

    simulationControlPanel.appendChild(simulateBtn);
    simulationControlPanel.appendChild(description);

    simulationContentDiv.appendChild(simulationControlPanel);
    assistantOutput.appendChild(simulationSection);
  }

  function displayImage(imageBase64, container) {
    const { section: imageSection, contentDiv: imageContentDiv } = createOutputSection('ğŸ–¼ï¸ ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø±', 'image', true, false); // ØªØµÙˆÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø¨Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
    const circuitImageContainer = document.createElement('div');
    circuitImageContainer.className = 'circuit-image-container';
    
    const img = document.createElement('img');
    img.src = imageBase64;
    img.alt = 'Ù…Ø¯Ø§Ø± ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡';
    img.className = 'output-image';

    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'image-button-container';

    const downloadBtn = document.createElement('a');
    downloadBtn.href = imageBase64;
    downloadBtn.download = `circuit-${Date.now()}.png`;
    downloadBtn.textContent = 'ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±';
    downloadBtn.className = 'btn-glass image-action-btn';

    const resizeBtn = document.createElement('button');
    resizeBtn.className = 'btn-glass image-action-btn';
    resizeBtn.textContent = 'ğŸ” ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡';
    let isLarge = false;
    resizeBtn.addEventListener('click', () => {
      isLarge = !isLarge;
      if (isLarge) {
        img.style.maxWidth = '100%';
        img.style.width = 'auto';
        img.style.height = 'auto';
        showToast('ØªØµÙˆÛŒØ± Ø¯Ø± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¨Ø²Ø±Ú¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯', 'info', 2000);
      } else {
        img.style.maxWidth = '300px';
        img.style.width = '100%';
        img.style.height = 'auto';
        showToast('ØªØµÙˆÛŒØ± Ø¯Ø± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©ÙˆÚ†Ú© Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯', 'info', 2000);
      }
    });

    buttonContainer.appendChild(downloadBtn);
    buttonContainer.appendChild(resizeBtn);
    circuitImageContainer.appendChild(img);
    circuitImageContainer.appendChild(buttonContainer);
    imageContentDiv.appendChild(circuitImageContainer);
    container.appendChild(imageSection);
  }

  messageContent.appendChild(assistantOutput);
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(messageContent);

  if (chatMessages) {
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }
}

// Create Output Section
function createOutputSection(title, type, isCollapsible = false, isCollapsed = false) {
  const section = document.createElement('div');
  section.className = 'output-section';

  if (isCollapsible) {
    section.classList.add('collapsible');
    if (isCollapsed) {
      section.classList.add('collapsed');
    }

    const header = document.createElement('div');
    header.className = 'output-section-header';

    const titleDiv = document.createElement('div');
    titleDiv.className = 'output-section-title';
    titleDiv.textContent = title;

    const previewDiv = document.createElement('div');
    previewDiv.className = 'output-section-preview';
    previewDiv.style.display = 'none'; // Initially hidden

    const collapseIcon = document.createElement('div');
    collapseIcon.className = 'collapse-icon';
    collapseIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>';

    header.appendChild(titleDiv);
    header.appendChild(previewDiv);
    header.appendChild(collapseIcon);

    header.addEventListener('click', () => {
      section.classList.toggle('collapsed');
      updatePreview(section, type);
    });

    const contentDiv = document.createElement('div');
    contentDiv.className = 'output-section-content';

    // Add preview update after content is added
    const observer = new MutationObserver(() => {
      updatePreview(section, type);
    });
    observer.observe(contentDiv, { childList: true, subtree: true });

    section.appendChild(header);
    section.appendChild(contentDiv);

    return { section, contentDiv };
  } else {
    const titleDiv = document.createElement('div');
    titleDiv.className = 'output-section-title';
    titleDiv.textContent = title;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'output-section-content';

    section.appendChild(titleDiv);
    section.appendChild(contentDiv);

    return { section, contentDiv };
  }
}

// Update preview for collapsed sections
function updatePreview(section, type) {
  const header = section.querySelector('.output-section-header');
  const previewDiv = header.querySelector('.output-section-preview');
  const contentDiv = section.querySelector('.output-section-content');

  if (section.classList.contains('collapsed')) {
    // Show preview
    let previewText = '';

    if (type === 'image') {
      previewText = 'ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø± (Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯)';
    } else {
      // Get first line of text content
      const textContent = contentDiv.textContent || '';
      const firstLine = textContent.split('\n')[0].trim();
      if (firstLine.length > 80) {
        previewText = firstLine.substring(0, 80) + '...';
      } else if (firstLine.length > 0) {
        previewText = firstLine;
      } else {
        previewText = 'Ù…Ø­ØªÙˆØ§ÛŒ Ø®Ø§Ù„ÛŒ';
      }
    }

    previewDiv.textContent = previewText;
    previewDiv.style.display = 'block';
    previewDiv.style.opacity = '0.7';
    previewDiv.style.fontSize = '12px';
    previewDiv.style.fontStyle = 'italic';
    previewDiv.style.marginRight = '10px';
    previewDiv.style.flex = '1';
    previewDiv.style.textAlign = 'right';
    previewDiv.style.direction = 'ltr';
    previewDiv.style.whiteSpace = 'nowrap';
    previewDiv.style.overflow = 'hidden';
    previewDiv.style.textOverflow = 'ellipsis';
  } else {
    // Hide preview
    previewDiv.style.display = 'none';
  }
}

// Add Loading Message
function addLoadingMessage() {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message assistant';
  messageDiv.id = `loading-${Date.now()}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = 'ğŸ¤–';
  
  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  
  const loading = document.createElement('div');
  loading.className = 'loading';
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement('div');
    dot.className = 'loading-dot';
    loading.appendChild(dot);
  }
  
  bubble.appendChild(loading);
  messageContent.appendChild(bubble);
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(messageContent);
  
  if (chatMessages) {
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }
  
  return messageDiv.id;
}

// Remove Message
function removeMessage(messageId) {
  const message = document.getElementById(messageId);
  if (message) {
    message.remove();
  }
}

// Scroll to Bottom
function scrollToBottom() {
  if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
}

// Set Status (deprecated - using toast now)
function setStatus(text, type = '') {
  if (text) {
    showToast(text, type);
  }
}

// Show Toast Notification
function showToast(message, type = 'info', duration = 3000) {
  const container = $('#toastContainer') || createToastContainer();
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const messageSpan = document.createElement('span');
  messageSpan.textContent = message;
  
  const closeBtn = document.createElement('button');
  closeBtn.className = 'toast-close';
  closeBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
  closeBtn.addEventListener('click', () => {
    removeToast(toast);
  });
  
  toast.appendChild(messageSpan);
  toast.appendChild(closeBtn);
  container.appendChild(toast);
  
  // Auto remove after duration
  if (duration > 0) {
    setTimeout(() => {
      removeToast(toast);
    }, duration);
  }
  
  return toast;
}

function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toastContainer';
  container.className = 'toast-container';
  document.body.appendChild(container);
  return container;
}

function removeToast(toast) {
  toast.style.animation = 'toastSlideIn 0.3s ease-out reverse';
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 300);
}

// Create New Chat
function createNewChat() {
  const newSessionId = `session-${Date.now()}`;
  switchSession(newSessionId);
  showToast('Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
  // Close sidebar after creating a new chat
  if (sidebar && !sidebar.classList.contains('collapsed')) {
    sidebar.classList.add('collapsed');
    localStorage.setItem('sidebarCollapsed', 'true');
  }
  updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯');
}

// Switch Session
async function switchSession(sessionId) {
  if (sessionId === currentSessionId) return;
  
  currentSessionId = sessionId;

  // Close sidebar if open
  if (sidebar && !sidebar.classList.contains('collapsed')) {
    sidebar.classList.add('collapsed');
    localStorage.setItem('sidebarCollapsed', 'true');
  }

  // Update active session
  $$('.session-item').forEach(item => {
    item.classList.remove('active');
  });
  const activeItem = $(`.session-item[data-session="${sessionId}"]`);
  if (activeItem) {
    activeItem.classList.add('active');
  } else {
    // Create new session item if it doesn't exist
    // This should ideally not happen if sessions are loaded from DB, but as a fallback
    addSessionItem(sessionId, 'Ú†Øª Ø¬Ø¯ÛŒØ¯');
    const newItem = $(`.session-item[data-session="${sessionId}"]`);
    if (newItem) newItem.classList.add('active');
  }
  
  // Load chat history
  await loadChatHistory(sessionId);
  const sessionNameElement = $(`.session-item[data-session="${sessionId}"] .session-name`);
  const sessionName = sessionNameElement ? sessionNameElement.textContent : 'Ú†Øª Ø¬Ø¯ÛŒØ¯';
  updateChatSessionTitle(sessionName);
}

// Load Chat History
async function loadChatHistory(sessionId) {
  try {
    const response = await fetch(`/api/chat/history/${sessionId}`);
    const data = await response.json();
    
    // Clear messages
    if (chatMessages) {
      chatMessages.innerHTML = '';
    }
    
    if (data.messages && data.messages.length > 0) {
      data.messages.forEach(msg => {
        if (msg.role === 'user') {
          addMessage('user', msg.content);
        } else if (msg.role === 'assistant') {
          addAssistantMessage({ content: msg.content });
        }
      });
      // Update chat session title with the latest session name
      const sessionNameElement = $(`.session-item[data-session="${sessionId}"] .session-name`);
      const sessionName = sessionNameElement ? sessionNameElement.textContent : 'Ú†Øª Ø¬Ø¯ÛŒØ¯';
      updateChatSessionTitle(sessionName);
    }
    else {
      // Show welcome message
      showWelcomeMessage();
      updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯'); // Reset title for empty chat
    }
    
    scrollToBottom();
  } catch (error) {
    console.error('Error loading chat history:', error);
    showWelcomeMessage();
    updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯'); // Reset title on error
  }
}

// Show Welcome Message
function showWelcomeMessage() {
  if (!chatMessages) return;
  chatMessages.innerHTML = `
    <div class="welcome-message">
      <div class="welcome-icon">âš¡</div>
      <h2>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h2>
      <p>ØªÙˆØ¶ÛŒØ­ Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ú©Ø¯ Ùˆ ØªØµÙˆÛŒØ± Ù…Ø¯Ø§Ø± Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù….</p>
      <div class="example-prompts">
        <div class="example-prompt glass-card" data-prompt="ÛŒÚ© ÙÛŒÙ„ØªØ± RC Ù¾Ø§ÛŒÛŒÙ†â€ŒÚ¯Ø°Ø± Ø¨Ø§ Ù…Ù‚Ø§ÙˆÙ…Øª 10k Ùˆ Ø®Ø§Ø²Ù† 10nF">
          <span>ÙÛŒÙ„ØªØ± RC Ù¾Ø§ÛŒÛŒÙ†â€ŒÚ¯Ø°Ø±</span>
        </div>
        <div class="example-prompt glass-card" data-prompt="ÛŒÚ© ØªÙ‚ÙˆÛŒØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø§ ÙÛŒØ¯Ø¨Ú© Ù…Ù†ÙÛŒ">
          <span>ØªÙ‚ÙˆÛŒØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</span>
        </div>
        <div class="example-prompt glass-card" data-prompt="ÛŒÚ© Ù…Ø¯Ø§Ø± Ù†ÙˆØ³Ø§Ù†â€ŒØ³Ø§Ø² RC">
          <span>Ù†ÙˆØ³Ø§Ù†â€ŒØ³Ø§Ø² RC</span>
        </div>
      </div>
    </div>
  `;
  
  // Re-attach event listeners for example prompts
  $$('.example-prompt').forEach(prompt => {
    prompt.addEventListener('click', () => {
      const text = prompt.getAttribute('data-prompt');
      chatInput.value = text;
      chatInput.focus();
    });
  });
}

// Load Chat Sessions
async function loadChatSessions() {
  if (!chatSessions) return; // Only run if chatSessions element exists

  try {
    const response = await fetch('/api/chat/sessions');
    const data = await response.json();
    
    chatSessions.innerHTML = '';
    
    // Add default session if not already in data.sessions
    const defaultSessionExists = data.sessions.some(s => s.sessionId === 'default');
    if (!defaultSessionExists) {
      addSessionItem('default', 'Ú†Øª Ø¬Ø¯ÛŒØ¯', currentSessionId === 'default');
    }
    
    // Add other sessions
    data.sessions.forEach(session => {
      const displayName = session.displayName || (() => {
        const date = new Date(session.lastMessage * 1000); // Convert Unix timestamp to milliseconds
        return date.toLocaleDateString('fa-IR', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      })();
      addSessionItem(session.sessionId, displayName, session.sessionId === currentSessionId);
    });
    
    // Ensure the current session is marked active, even if it was just created or is 'default'
    const activeItem = $(`.session-item[data-session="${currentSessionId}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }

    // Update chat session title with the latest session name
    const currentSessionItem = $(`.session-item[data-session="${currentSessionId}"]`);
    if (currentSessionItem) {
      updateChatSessionTitle(currentSessionItem.querySelector('.session-name').textContent);
    }
    else {
      updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯'); // Fallback if current session not found
    }
  } catch (error) {
    console.error('Error loading sessions:', error);
  }
}

// Add Session Item
function addSessionItem(sessionId, name, isActive = false) {
  const item = document.createElement('div');
  item.className = `session-item ${isActive ? 'active' : ''}`;
  item.setAttribute('data-session', sessionId);
  
  const nameSpan = document.createElement('span');
  nameSpan.className = 'session-name';
  nameSpan.textContent = name;
  nameSpan.setAttribute('contenteditable', 'false');
  
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'session-actions';
  
  const editBtn = document.createElement('button');
  editBtn.className = 'btn-edit-session';
  editBtn.setAttribute('data-session', sessionId);
  editBtn.title = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…';
  editBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
  
  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'btn-delete-session';
  deleteBtn.setAttribute('data-session', sessionId);
  deleteBtn.title = 'Ø­Ø°Ù';
  deleteBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
  
  actionsDiv.appendChild(editBtn);
  if (sessionId !== 'default') {
    actionsDiv.appendChild(deleteBtn);
  }
  
  item.appendChild(nameSpan);
  item.appendChild(actionsDiv);
  
  chatSessions.appendChild(item);
}

// Clear Current Chat
async function clearCurrentChat() {
  if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú†Øª Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/chat/history/${currentSessionId}/delete`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': csrftoken } // Include CSRF token
    });
    
    if (response.ok) {
      if (chatMessages) {
        chatMessages.innerHTML = '';
      }
      showWelcomeMessage();
      showToast('Ú†Øª Ù¾Ø§Ú© Ø´Ø¯', 'success');
      loadChatSessions();
      updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯'); // Reset title after clearing chat
    }
  }
  catch (error) {
    showToast(`Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú†Øª: ${error.message}`, 'error');
  }
}

// Delete Session
async function deleteSession(sessionId) {
  if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø³Ø´Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/chat/history/${sessionId}`, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': csrftoken } // Include CSRF token
    });
    
    if (response.ok) {
      if (sessionId === currentSessionId) {
        currentSessionId = 'default';
        await loadChatHistory('default');
        updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯'); // Reset title after deleting active chat
      }
      loadChatSessions();
      showToast('Ø³Ø´Ù† Ø­Ø°Ù Ø´Ø¯', 'success');
    }
  }
  catch (error) {
    showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø´Ù†: ${error.message}`, 'error');
  }
}

// Toggle Sidebar
function toggleSidebar() {
  if (!sidebar) return; // Only run if sidebar exists (user is authenticated)
  const isCollapsed = sidebar.classList.toggle('collapsed');
  // No need to add/remove class to body, as chat-main adjusts its margin
  // Save state to localStorage
  localStorage.setItem('sidebarCollapsed', isCollapsed);
}

// Edit Session Name
function editSessionName(sessionId) {
  const sessionItem = $(`.session-item[data-session="${sessionId}"]`);
  if (!sessionItem) return;
  
  const nameSpan = sessionItem.querySelector('.session-name');
  if (!nameSpan) return;
  
  const originalName = nameSpan.textContent;
  nameSpan.setAttribute('contenteditable', 'true');
  nameSpan.focus();
  
  // Select all text
  const range = document.createRange();
  range.selectNodeContents(nameSpan);
  const selection = window.getSelection();
  selection.removeAllRanges();
  selection.addRange(range);
  
  const finishEdit = async () => {
    const newName = nameSpan.textContent.trim() || originalName;
    nameSpan.setAttribute('contenteditable', 'false');
    
    if (newName !== originalName) { // Allow renaming 'default' session to ensure it's saved to DB
      try {
        const response = await fetch(`/api/chat/history/${sessionId}/rename`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken // Include CSRF token
          },
          body: JSON.stringify({ name: newName })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // Update session ID if it changed (though with DB, it shouldn't change here)
          if (data.newSessionId !== sessionId) {
            sessionItem.setAttribute('data-session', data.newSessionId);
            sessionItem.querySelector('.btn-edit-session').setAttribute('data-session', data.newSessionId);
            if (sessionItem.querySelector('.btn-delete-session')) {
              sessionItem.querySelector('.btn-delete-session').setAttribute('data-session', data.newSessionId);
            }
            
            // Update current session ID if it was the active one
            if (currentSessionId === sessionId) {
              currentSessionId = data.newSessionId;
            }
          }
          
          nameSpan.textContent = data.displayName || newName;
          showToast('Ù†Ø§Ù… Ú†Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
          // Close sidebar after renaming a session
          if (sidebar && !sidebar.classList.contains('collapsed')) {
            sidebar.classList.add('collapsed');
            localStorage.setItem('sidebarCollapsed', 'true');
          }
          updateChatSessionTitle(newName); // Update header title after successful rename
        }
        else {
          nameSpan.textContent = originalName;
          showToast(data.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù†Ø§Ù…', 'error');
        }
      }
      catch (error) {
        nameSpan.textContent = originalName;
        showToast('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù†Ø§Ù…', 'error');
      }
    }
    else {
      nameSpan.textContent = originalName;
    }
  };
  
  nameSpan.addEventListener('blur', finishEdit, { once: true });
  nameSpan.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      nameSpan.blur();
    }
    else if (e.key === 'Escape') {
      nameSpan.textContent = originalName;
      nameSpan.setAttribute('contenteditable', 'false');
    }
  }, { once: true });
}

// Load sidebar state from localStorage
function loadSidebarState() {
  if (!sidebar) return; // Only run if sidebar exists (user is authenticated)
  const collapsed = localStorage.getItem('sidebarCollapsed') === 'true';
  // If no state saved, default to collapsed for this new behavior
  if (collapsed || localStorage.getItem('sidebarCollapsed') === null) {
    sidebar.classList.add('collapsed');
  }
  else {
    sidebar.classList.remove('collapsed');
  }
}

// Function to update the chat session title in the header
function updateChatSessionTitle(title) {
  if (chatSessionTitle) {
    chatSessionTitle.textContent = title;
  }
}

// Circuit Simulation Mode Functions
let simulationMode = false;

function enterCircuitSimulationMode(content) {
  if (simulationMode) return; // Already in simulation mode

  simulationMode = true;

  // Hide chat input
  const chatInputContainer = $('.chat-input-container');
  if (chatInputContainer) {
    chatInputContainer.style.display = 'none';
  }

  // Hide chat-only buttons in header
  const chatOnlyButtons = $$('.chat-only');
  chatOnlyButtons.forEach(btn => {
    btn.style.display = 'none';
  });

  // Clear chat messages and show simulation interface
  const chatMessages = $('#chatMessages');
  if (chatMessages) {
    chatMessages.innerHTML = '';
    chatMessages.style.paddingTop = '0';
    chatMessages.style.paddingBottom = '0';
  }

  // Update header title
  updateChatSessionTitle('Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ø§Ø±');

  // Create simulation interface
  createSimulationInterface(content);

  // Show exit button in header
  addExitSimulationButton();
}

function createSimulationInterface(content) {
  const chatMessages = $('#chatMessages');
  if (!chatMessages) return;

  // Create main simulation container
  const simulationContainer = document.createElement('div');
  simulationContainer.className = 'circuit-simulation-container';
  simulationContainer.style.cssText = `
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 20px;
    gap: 20px;
    overflow-y: auto;
  `;

  // Header section with circuit info
  const headerSection = document.createElement('div');
  headerSection.className = 'simulation-header';
  headerSection.style.cssText = `
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    border: 1px solid var(--stroke);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  `;

  const headerTitle = document.createElement('h2');
  headerTitle.textContent = 'ğŸ› ï¸ Ù…Ø­ÛŒØ· Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ø§Ø±';
  headerTitle.style.cssText = 'margin: 0 0 16px 0; color: var(--white); font-size: 24px; font-weight: 600;';

  const headerDesc = document.createElement('p');
  headerDesc.textContent = 'Ù…Ø¯Ø§Ø± Ø®ÙˆØ¯ Ø±Ø§ ØªØ­Ù„ÛŒÙ„ Ú©Ù†ÛŒØ¯ØŒ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ù†ØªØ§ÛŒØ¬ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.';
  headerDesc.style.cssText = 'margin: 0; color: var(--white-60); font-size: 14px;';

  headerSection.appendChild(headerTitle);
  headerSection.appendChild(headerDesc);

  // Main content grid
  const mainGrid = document.createElement('div');
  mainGrid.className = 'simulation-main-grid';
  mainGrid.style.cssText = `
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    flex: 1;
    min-height: 600px;
  `;

  // Left panel - Schematic and Netlist
  const leftPanel = document.createElement('div');
  leftPanel.className = 'simulation-left-panel';
  leftPanel.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 20px;
  `;

  // Schematic section
  const schematicSection = createCollapsibleSection('ğŸ“ Ø´Ù…Ø§ØªÛŒÚ© Ù…Ø¯Ø§Ø±', 'schematic');
  const schematicContent = schematicSection.contentDiv;

  // Netlist section
  const netlistSection = createCollapsibleSection('ğŸ“ Ù†Øªâ€ŒÙ„ÛŒØ³Øª', 'netlist');
  const netlistContent = netlistSection.contentDiv;

  // Right panel - Simulation Controls and Results
  const rightPanel = document.createElement('div');
  rightPanel.className = 'simulation-right-panel';
  rightPanel.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 20px;
  `;

  // Simulation controls
  const controlsSection = createCollapsibleSection('âš™ï¸ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ', 'controls');
  const controlsContent = controlsSection.contentDiv;

  // Results section
  const resultsSection = createCollapsibleSection('ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ', 'results');
  const resultsContent = resultsSection.contentDiv;

  // Initialize content
  initializeSchematicSection(schematicContent, content);
  initializeNetlistSection(netlistContent, content);
  initializeControlsSection(controlsContent, content);
  initializeResultsSection(resultsContent);

  // Assemble panels
  leftPanel.appendChild(schematicSection.section);
  leftPanel.appendChild(netlistSection.section);

  rightPanel.appendChild(controlsSection.section);
  rightPanel.appendChild(resultsSection.section);

  mainGrid.appendChild(leftPanel);
  mainGrid.appendChild(rightPanel);

  simulationContainer.appendChild(headerSection);
  simulationContainer.appendChild(mainGrid);

  chatMessages.appendChild(simulationContainer);
}

function createCollapsibleSection(title, type) {
  const section = document.createElement('div');
  section.className = 'output-section';
  section.style.cssText = `
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    border: 1px solid var(--stroke);
    border-radius: 12px;
    flex: 1;
    min-height: 300px;
    display: flex;
    flex-direction: column;
  `;

  const header = document.createElement('div');
  header.className = 'output-section-header';
  header.style.cssText = `
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
    border-bottom: 1px solid var(--stroke);
  `;

  const titleDiv = document.createElement('div');
  titleDiv.className = 'output-section-title';
  titleDiv.textContent = title;
  titleDiv.style.cssText = 'font-size: 12px; font-weight: 600; color: var(--white-70); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;';

  const contentDiv = document.createElement('div');
  contentDiv.className = 'output-section-content';
  contentDiv.style.cssText = 'flex: 1; padding: 16px; overflow-y: auto;';

  header.addEventListener('click', () => {
    section.classList.toggle('collapsed');
  });

  header.appendChild(titleDiv);
  section.appendChild(header);
  section.appendChild(contentDiv);

  return { section, contentDiv };
}

function initializeSchematicSection(container, content) {
  container.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="margin-bottom: 20px;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--white-40)" stroke-width="1">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="9" cy="9" r="2"/>
          <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
        </svg>
      </div>
      <p style="color: var(--white-60); margin: 0;">Ø´Ù…Ø§ØªÛŒÚ© Ù…Ø¯Ø§Ø± Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
      <button class="btn-glass" style="margin-top: 20px; padding: 10px 20px;" onclick="generateSchematic()">
        ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§ØªÛŒÚ©
      </button>
    </div>
  `;
}

function initializeNetlistSection(container, content) {
  // Ø§Ú¯Ø± Ú©Ø¯ SPICE ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø³Ø¹ÛŒ Ú©Ù† ØªÙˆÙ„ÛŒØ¯ Ú©Ù†
  const initialSpiceCode = content.spiceCode || '';

  const netlistTextarea = document.createElement('textarea');
  netlistTextarea.className = 'netlist-editor';
  netlistTextarea.value = initialSpiceCode;
  netlistTextarea.placeholder = 'Ú©Ø¯ SPICE Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...';
  netlistTextarea.style.cssText = `
    width: 100%;
    height: 300px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--stroke);
    border-radius: 8px;
    color: var(--white-90);
    font-family: 'Courier New', monospace;
    font-size: 13px;
    padding: 16px;
    resize: vertical;
    outline: none;
    line-height: 1.6;
  `;

  netlistTextarea.addEventListener('focus', function() {
    this.style.borderColor = 'var(--white-50)';
    this.style.boxShadow = '0 0 0 2px rgba(255, 255, 255, 0.1)';
  });

  netlistTextarea.addEventListener('blur', function() {
    this.style.borderColor = 'var(--stroke)';
    this.style.boxShadow = 'none';
  });

  container.appendChild(netlistTextarea);

  // Button container
  const buttonContainer = document.createElement('div');
  buttonContainer.style.cssText = 'display: flex; gap: 8px; margin-top: 12px; align-items: center;';

  // Generate SPICE button
  const generateBtn = document.createElement('button');
  generateBtn.className = 'btn-glass';
  generateBtn.textContent = 'ğŸ”Œ ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ SPICE';
  generateBtn.style.cssText = 'padding: 8px 16px; font-size: 12px;';
  generateBtn.addEventListener('click', () => {
    generateSpiceCode(netlistTextarea, content);
  });

  // Save button
  const saveBtn = document.createElement('button');
  saveBtn.className = 'btn-glass';
  saveBtn.textContent = 'Ø°Ø®ÛŒØ±Ù‡ Ù†Øªâ€ŒÙ„ÛŒØ³Øª';
  saveBtn.style.cssText = 'padding: 8px 16px; font-size: 12px;';
  saveBtn.addEventListener('click', () => {
    showToast('Ù†Øªâ€ŒÙ„ÛŒØ³Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
  });

  buttonContainer.appendChild(generateBtn);
  buttonContainer.appendChild(saveBtn);
  container.appendChild(buttonContainer);

  // Ø§Ú¯Ø± Ú©Ø¯ SPICE ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆÙ„ÛŒØ¯ Ú©Ù†
  if (!initialSpiceCode.trim()) {
    setTimeout(() => generateSpiceCode(netlistTextarea, content), 500);
  }
}

function generateSpiceCode(textarea, content) {
  // Get user text from the last message
  const messages = document.querySelectorAll('.message.user');
  if (messages.length === 0) {
    showToast('Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
    return;
  }

  const lastUserMessage = messages[messages.length - 1];
  const userText = lastUserMessage.querySelector('.message-bubble').textContent.trim();

  if (!userText) {
    showToast('Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª', 'error');
    return;
  }

  // Show loading
  textarea.value = 'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ SPICE...';
  textarea.disabled = true;

  // Call SPICE generation API
  fetch('/api/spice/generate/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      user_text: userText
    })
  })
  .then(response => response.json())
  .then(data => {
    textarea.disabled = false;

    if (data.success) {
      textarea.value = data.spice_code;
      showToast('Ú©Ø¯ SPICE Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯', 'success');

      // Update components for schematic generation
      if (data.components && data.components.length > 0) {
        // Store components for later use
        textarea.dataset.components = JSON.stringify(data.components);
      }
    } else {
      textarea.value = '';
      showToast('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ SPICE: ' + (data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'), 'error');
    }
  })
  .catch(error => {
    console.error('Error generating SPICE:', error);
    textarea.disabled = false;
    textarea.value = '';
    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
  });
}

function initializeControlsSection(container, content) {
  container.innerHTML = `
    <div class="simulation-controls">
      <div style="margin-bottom: 20px;">
        <label style="color: var(--white-70); font-size: 12px; font-weight: 600; margin-bottom: 8px; display: block;">Ù†ÙˆØ¹ ØªØ­Ù„ÛŒÙ„</label>
        <select id="analysisType" class="input-glass" style="width: 100%; padding: 12px; font-size: 14px;">
          <option value="transient">Transient (Ø²Ù…Ø§Ù†ÛŒ)</option>
          <option value="ac">AC Sweep (ÙØ±Ú©Ø§Ù†Ø³ÛŒ)</option>
          <option value="dc">DC Sweep</option>
          <option value="op">Operating Point (Ù†Ù‚Ø·Ù‡ Ú©Ø§Ø±)</option>
        </select>
      </div>

      <div id="transientControls" class="analysis-controls" style="display: block;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">Ú¯Ø§Ù… Ø²Ù…Ø§Ù†ÛŒ</label>
            <input type="text" id="stepTime" class="input-glass" value="1ms" style="width: 100%; padding: 8px;">
          </div>
          <div>
            <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†</label>
            <input type="text" id="stopTime" class="input-glass" value="100ms" style="width: 100%; padding: 8px;">
          </div>
        </div>
      </div>

      <div id="acControls" class="analysis-controls" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">Ù†Ù‚Ø§Ø· Ø¯Ø± Ø¯Ù‡Ù‡</label>
            <input type="text" id="pointsPerDecade" class="input-glass" value="10" style="width: 100%; padding: 8px;">
          </div>
          <div>
            <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">ÙØ±Ú©Ø§Ù†Ø³ Ù¾Ø§ÛŒØ§Ù†</label>
            <input type="text" id="stopFreq" class="input-glass" value="1MHz" style="width: 100%; padding: 8px;">
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">Ù…Ù‚ÛŒØ§Ø³ Ù†Ù…Ø§ÛŒØ´</label>
          <div style="display: flex; gap: 12px;">
            <label style="color: var(--white-70); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <input type="radio" name="acScale" value="db" checked> Ø¯Ø³ÛŒâ€ŒØ¨Ù„ (dB)
            </label>
            <label style="color: var(--white-70); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <input type="radio" name="acScale" value="magnitude"> Ø§Ù†Ø¯Ø§Ø²Ù‡ (V)
            </label>
          </div>
        </div>
      </div>

      <div id="dcControls" class="analysis-controls" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div>
            <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">Ù…Ù†Ø¨Ø¹</label>
            <input type="text" id="dcSource" class="input-glass" value="V1" style="width: 100%; padding: 8px;">
          </div>
          <div>
            <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">Ø´Ø±ÙˆØ¹</label>
            <input type="text" id="dcStart" class="input-glass" value="0" style="width: 100%; padding: 8px;">
          </div>
          <div>
            <label style="color: var(--white-60); font-size: 11px; display: block; margin-bottom: 4px;">Ù¾Ø§ÛŒØ§Ù†</label>
            <input type="text" id="dcStop" class="input-glass" value="5" style="width: 100%; padding: 8px;">
          </div>
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="color: var(--white-70); font-size: 12px; font-weight: 600; margin-bottom: 8px; display: block;">Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù…</label>
        <select id="plotSignal" class="input-glass" style="width: 100%; padding: 12px; font-size: 14px;">
          <option value="v(out)">v(out)</option>
          <option value="v(in)">v(in)</option>
          <option value="i(v1)">i(v1)</option>
        </select>
      </div>

      <button id="runSimulationBtn" class="btn-glass" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600;">
        ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ
      </button>
    </div>
  `;

  // Add event listeners for analysis type change
  const analysisType = container.querySelector('#analysisType');
  const transientControls = container.querySelector('#transientControls');
  const acControls = container.querySelector('#acControls');
  const dcControls = container.querySelector('#dcControls');

  analysisType.addEventListener('change', function() {
    // Hide all controls
    transientControls.style.display = 'none';
    acControls.style.display = 'none';
    dcControls.style.display = 'none';

    // Show selected controls
    switch(this.value) {
      case 'transient':
        transientControls.style.display = 'block';
        break;
      case 'ac':
        acControls.style.display = 'block';
        break;
      case 'dc':
        dcControls.style.display = 'block';
        break;
    }
  });

  // Add run simulation event
  const runBtn = container.querySelector('#runSimulationBtn');
  runBtn.addEventListener('click', () => runSimulation());
}

function initializeResultsSection(container) {
  container.innerHTML = `
    <div class="simulation-results" style="text-align: center; padding: 40px;">
      <div style="margin-bottom: 20px;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--white-40)" stroke-width="1">
          <path d="M3 3v18h18"/>
          <path d="m19 9-5 5-4-4-3 3"/>
        </svg>
      </div>
      <p style="color: var(--white-60); margin: 0 0 20px 0;">Ù†ØªØ§ÛŒØ¬ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
      <div id="simulationStatus" style="color: var(--white-50); font-size: 12px;">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ</div>
    </div>
  `;
}

function addExitSimulationButton() {
  const headerActions = $('.header-actions');
  if (!headerActions) return;

  // Remove existing exit button if any
  const existingExitBtn = headerActions.querySelector('.exit-simulation-btn');
  if (existingExitBtn) {
    existingExitBtn.remove();
  }

  const exitBtn = document.createElement('button');
  exitBtn.className = 'btn-glass btn-icon exit-simulation-btn';
  exitBtn.title = 'Ø®Ø±ÙˆØ¬ Ø§Ø² Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ';
  exitBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>';
  exitBtn.addEventListener('click', exitCircuitSimulationMode);

  headerActions.appendChild(exitBtn);
}

function exitCircuitSimulationMode() {
  simulationMode = false;

  // Show chat input
  const chatInputContainer = $('.chat-input-container');
  if (chatInputContainer) {
    chatInputContainer.style.display = '';
  }

  // Show chat-only buttons in header
  const chatOnlyButtons = $$('.chat-only');
  chatOnlyButtons.forEach(btn => {
    btn.style.display = '';
  });

  // Clear simulation interface and show chat
  loadChatHistory(currentSessionId);

  // Update header title
  updateChatSessionTitle('Ú†Øª Ø¬Ø¯ÛŒØ¯');

  // Remove exit button
  const exitBtn = $('.exit-simulation-btn');
  if (exitBtn) {
    exitBtn.remove();
  }
}

function runSimulation() {
  const statusDiv = document.querySelector('#simulationStatus');
  if (statusDiv) {
    statusDiv.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ...';
    statusDiv.style.color = 'var(--white-70)';
  }

  // Get simulation parameters
  const analysisTypeElement = document.querySelector('#analysisType');
  const plotSignalElement = document.querySelector('#plotSignal');
  const netlistTextarea = document.querySelector('.netlist-editor');

  if (!analysisTypeElement || !plotSignalElement) {
    showToast('Ø¹Ù†Ø§ØµØ± Ú©Ù†ØªØ±Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø§Ø´ÛŒØ¯.', 'error');
    return;
  }

  if (!netlistTextarea) {
    showToast('Ù†Øªâ€ŒÙ„ÛŒØ³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
    return;
  }

  const analysisType = analysisTypeElement.value;
  const plotSignal = plotSignalElement.value;
  const spiceCode = netlistTextarea.value.trim();

  if (!spiceCode) {
    showToast('Ù†Øªâ€ŒÙ„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª', 'error');
    return;
  }

  // Collect parameters based on analysis type
  const parameters = {};

  if (analysisType === 'transient') {
    const stepElement = document.querySelector('#stepTime');
    const stopElement = document.querySelector('#stopTime');
    const uicElement = document.querySelector('#transientControls input[type="checkbox"]');

    if (stepElement) parameters.step = stepElement.value;
    if (stopElement) parameters.stop = stopElement.value;
    if (uicElement) parameters.uic = uicElement.checked;
  } else if (analysisType === 'ac') {
    const pointsElement = document.querySelector('#pointsPerDecade');
    const fstopElement = document.querySelector('#stopFreq');
    const acScaleElement = document.querySelector('input[name="acScale"]:checked');

    if (pointsElement) parameters.points = pointsElement.value;
    if (fstopElement) {
      parameters.fstart = '1'; // Default start frequency
      parameters.fstop = fstopElement.value;
    }
    if (acScaleElement) parameters.ac_scale = acScaleElement.value;
  } else if (analysisType === 'dc') {
    const sourceElement = document.querySelector('#dcSource');
    const startElement = document.querySelector('#dcStart');
    const stopElement = document.querySelector('#dcStop');
    const stepElement = document.querySelector('#dcControls input[placeholder="Step"]');

    if (sourceElement) parameters.source = sourceElement.value;
    if (startElement) parameters.start = startElement.value;
    if (stopElement) parameters.stop = stopElement.value;
    if (stepElement) parameters.step = stepElement.value;
  }

  // Call simulation API
  fetch('/api/simulation/run/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      spice_code: spiceCode,
      analysis_type: analysisType,
      parameters: parameters,
      plot_signal: plotSignal
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update status
      if (statusDiv) {
        statusDiv.textContent = 'Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯ âœ“';
        statusDiv.style.color = '#44ff44';
      }

      // Display results
      // Display results or error
      if (data.data && data.data.error) {
        displaySimulationError(data.data.error);
      } else {
        displaySimulationResults(data);
        showToast('Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯', 'success');
      }
    } else {
      if (statusDiv) {
        statusDiv.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ âœ—';
        statusDiv.style.color = '#ff4444';
      }
      showToast('Ø®Ø·Ø§ Ø¯Ø± Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ: ' + (data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'), 'error');
    }
  })
  .catch(error => {
    console.error('Error running simulation:', error);
    if (statusDiv) {
      statusDiv.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· âœ—';
      statusDiv.style.color = '#ff4444';
    }
    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
  });
}

function displaySimulationResults(data) {
  const resultsContainer = document.querySelector('.simulation-right-panel .output-section-content');
  if (!resultsContainer) return;

  const resultData = data.data;
  let html = '';

  if (resultData.type === 'scalars') {
    // DC Operating Point results
    html = `
      <div class="simulation-results-table">
        <h4 style="color: var(--white); margin-bottom: 16px;">Ù†ØªØ§ÛŒØ¬ DC Operating Point</h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr style="background: rgba(255, 255, 255, 0.1);">
                <th style="padding: 8px; text-align: right; border: 1px solid var(--stroke); color: var(--white-80);">Ù¾Ø§Ø±Ø§Ù…ØªØ±</th>
                <th style="padding: 8px; text-align: left; border: 1px solid var(--stroke); color: var(--white-80);">Ù…Ù‚Ø¯Ø§Ø±</th>
              </tr>
            </thead>
            <tbody>
    `;

    resultData.values.forEach(([param, value]) => {
      html += `
        <tr>
          <td style="padding: 8px; border: 1px solid var(--stroke); color: var(--white-90); font-family: monospace;">${param}</td>
          <td style="padding: 8px; border: 1px solid var(--stroke); color: var(--white); font-family: monospace;">${value}</td>
        </tr>
      `;
    });

    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  } else if (resultData.type === 'plot' && data.plot_base64) {
    // Plot results
    html = `
      <div class="simulation-results-plot">
        <h4 style="color: var(--white); margin-bottom: 16px;">Ù†Ù…ÙˆØ¯Ø§Ø± Ù†ØªØ§ÛŒØ¬ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ</h4>
        <img src="${data.plot_base64}" alt="Ù†ØªØ§ÛŒØ¬ Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ" style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--stroke);">
        <div style="margin-top: 16px;">
          <a href="${data.plot_base64}" download="simulation-plot.png" class="btn-glass">
            ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ù…ÙˆØ¯Ø§Ø±
          </a>
        </div>
      </div>
    `;
  } else {
    // Raw output fallback
    html = `
      <div class="simulation-results-raw">
        <h4 style="color: var(--white); margin-bottom: 16px;">Ø®Ø±ÙˆØ¬ÛŒ Ø®Ø§Ù… Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ</h4>
        <pre style="background: rgba(0, 0, 0, 0.4); padding: 16px; border-radius: 8px; border: 1px solid var(--stroke); color: var(--white-90); font-size: 12px; overflow-x: auto; max-height: 300px; overflow-y: auto;">${data.raw_output}</pre>
      </div>
    `;
  }

  resultsContainer.innerHTML = html;
}

function displaySimulationError(errorMessage) {
  const resultsContainer = document.querySelector('.simulation-right-panel .output-section-content');
  if (!resultsContainer) return;

  let html = `
    <div class="simulation-error">
      <h4 style="color: #ff6b6b; margin-bottom: 16px;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø´ÛŒÙ…Ù‡â€ŒØ³Ø§Ø²ÛŒ</h4>
      <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
        <p style="color: #ff6b6b; margin: 0; font-family: monospace; font-size: 14px;">${errorMessage}</p>
      </div>
  `;

  // Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒ ngspice Ø¨Ø§Ø´Ø¯ØŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ù†ØµØ¨ Ø¨Ø¯Ù‡
  if (errorMessage.includes('Ngspice not found')) {
    html += `
      <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 16px;">
        <h5 style="color: var(--white); margin-bottom: 12px;">ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù†ØµØ¨ Ngspice:</h5>
        <ol style="color: var(--white-80); margin: 0; padding-right: 20px;">
          <li>Ø§Ø² ÙˆØ¨â€ŒØ³Ø§ÛŒØª <a href="https://ngspice.sourceforge.io/" target="_blank" style="color: #44aaff;">ngspice.sourceforge.io</a> Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯</li>
          <li>Ù†Ø³Ø®Ù‡ Windows Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯</li>
          <li>Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ Ù…Ø³ÛŒØ± Ù†ØµØ¨ Ø¯Ø± PATH Ø³ÛŒØ³ØªÙ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡</li>
          <li>ÛŒØ§ ÙØ§ÛŒÙ„ ngspice_con.exe Ø±Ø§ Ø¯Ø± Ù…Ø³ÛŒØ± Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯</li>
        </ol>
      </div>
    `;
  }

  html += `</div>`;

  resultsContainer.innerHTML = html;
}

function generateSchematic() {
  const schematicContainer = document.querySelector('.simulation-left-panel .output-section-content');
  if (!schematicContainer) return;

  // Show loading
  schematicContainer.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="margin-bottom: 20px;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--white-60)" stroke-width="2">
          <circle cx="12" cy="12" r="10" stroke-dasharray="20 20" stroke-linecap="round">
            <animate attributeName="stroke-dashoffset" values="0;-40" dur="1s" repeatCount="indefinite"/>
          </circle>
        </svg>
      </div>
      <p style="color: var(--white-60); margin: 0;">Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§ØªÛŒÚ©...</p>
    </div>
  `;

  // Get netlist content
  const netlistTextarea = document.querySelector('.netlist-editor');
  if (!netlistTextarea) {
    showToast('Ù†Øªâ€ŒÙ„ÛŒØ³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
    return;
  }

  const spiceCode = netlistTextarea.value.trim();
  if (!spiceCode) {
    showToast('Ù†Øªâ€ŒÙ„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª', 'error');
    return;
  }

  // Get components from current message content
  let components = [];
  const currentMessage = document.querySelector('.message.assistant:last-child');
  if (currentMessage) {
    try {
      // Try to find components in message data
      const contentDiv = currentMessage.querySelector('.assistant-output');
      if (contentDiv) {
        // This is a simplified approach - in a real implementation,
        // we'd store component data in a data attribute or global variable
        components = extractComponentsFromSpice(spiceCode);
      }
    } catch (e) {
      console.error('Error extracting components:', e);
    }
  }

  // Call API to generate schematic
  fetch('/api/schematic/generate/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      components: components,
      spice_code: spiceCode
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.schematic_base64) {
      schematicContainer.innerHTML = `
        <div style="text-align: center;">
          <img src="${data.schematic_base64}" alt="Ø´Ù…Ø§ØªÛŒÚ© Ù…Ø¯Ø§Ø±" style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--stroke);">
          <div style="margin-top: 16px;">
            <button class="btn-glass" onclick="generateSchematic()" style="margin-right: 8px;">
              ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
            </button>
            <a href="${data.schematic_base64}" download="schematic.png" class="btn-glass">
              ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯
            </a>
          </div>
        </div>
      `;
      showToast('Ø´Ù…Ø§ØªÛŒÚ© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯', 'success');
    } else {
      schematicContainer.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div style="margin-bottom: 20px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--white-40)" stroke-width="1">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
          </div>
          <p style="color: var(--white-60); margin: 0 0 20px 0;">Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§ØªÛŒÚ©</p>
          <p style="color: var(--white-50); font-size: 12px; margin: 0;">${data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
          <button class="btn-glass" onclick="generateSchematic()" style="margin-top: 20px;">
            ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
          </button>
        </div>
      `;
      showToast('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§ØªÛŒÚ©: ' + (data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'), 'error');
    }
  })
  .catch(error => {
    console.error('Error generating schematic:', error);
    schematicContainer.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div style="margin-bottom: 20px;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--white-40)" stroke-width="1">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
        </div>
        <p style="color: var(--white-60); margin: 0 0 20px 0;">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±</p>
        <button class="btn-glass" onclick="generateSchematic()" style="margin-top: 20px;">
          ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
        </button>
      </div>
    `;
    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
  });
}

function extractComponentsFromSpice(spiceCode) {
  const components = [];
  const lines = spiceCode.split('\n');

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('.') || trimmed.startsWith('*')) {
      continue;
    }

    const parts = trimmed.split(/\s+/);
    if (parts.length < 3) continue;

    const name = parts[0];
    const type = name[0].toUpperCase();

    if (['R', 'C', 'L', 'V', 'I', 'D'].includes(type)) {
      components.push({
        ref: name,
        type: type,
        value: parts[3] || '',
        nodes: [parts[1], parts[2]]
      });
    } else if (['Q', 'M'].includes(type)) {
      components.push({
        ref: name,
        type: type,
        nodes: parts.slice(1, 4)
      });
    }
  }

  return components;
}

// Function to toggle between settings and history
function toggleSettingsHistory() {
  if (settingsSection && historySection) {
    if (settingsSection.classList.contains('active')) {
      settingsSection.classList.remove('active');
      historySection.classList.add('active');
    }
    else {
      historySection.classList.remove('active');
      settingsSection.classList.add('active');
    }
  }
}

    </script>
    
    
    
    <style>
      :root {
        --bg-black: #000000;
        --bg-dark: #0a0a0a;
        --bg-darker: #050505;
        --white: #ffffff;
        --white-90: rgba(255, 255, 255, 0.9);
        --white-80: rgba(255, 255, 255, 0.8);
        --white-70: rgba(255, 255, 255, 0.7);
        --white-60: rgba(255, 255, 255, 0.6);
        --white-50: rgba(255, 255, 255, 0.5);
        --white-40: rgba(255, 255, 255, 0.4);
        --white-30: rgba(255, 255, 255, 0.3);
        --white-20: rgba(255, 255, 255, 0.2);
        --white-10: rgba(255, 255, 255, 0.1);
        --white-5: rgba(255, 255, 255, 0.05);
        --stroke: rgba(255, 255, 255, 0.15);
        --stroke-hover: rgba(255, 255, 255, 0.3);
        --glow: rgba(255, 255, 255, 0.1);
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Vazirmatn', 'IRANSans', sans-serif;
        background: var(--bg-black);
        color: var(--white);
        height: auto;
        min-height: 100vh;
        overflow-x: hidden;
        overflow-y: auto;
        direction: rtl;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        scroll-behavior: smooth;
      }
    
      /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø±ÙˆØ§Ù† Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ */
      html {
        scroll-behavior: smooth;
      }
    
      /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø±Ø§ÛŒ ÙˆØ¨â€ŒÚ©ÛŒØª (Safari, Chrome, Edge) */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
    
      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }
    
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        transition: background 0.3s ease;
      }
    
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
    
      /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05);
      }
      
      /* Glass Effect */
      .glass-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--stroke);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      
      .glass-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--stroke-hover);
      }
      
      /* App Container session */
      .app-container {
        display: flex;
        height: auto;
        min-height: 100vh;
        overflow-x: hidden;
        overflow-y: auto;
        background: var(--bg-black);
        position: relative;
        width: 100%;
        --chat-header-height: 70px; /* Approximate height of chat-header */
        --chat-input-height: 120px; /* Approximate height of chat-input-container */
      }
      
      .app-container.login-page {
        display: block;
        justify-content: unset;
        align-items: unset;
        height: auto;
        min-height: 100vh;
        width: 100vw;
        overflow-x: hidden;
        overflow-y: auto;
      }
    
      .app-container::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.02) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
      }
      
      /* Sidebar */
      .sidebar {
        width: 360px;
        background: rgba(10, 10, 10, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-left: 1px solid var(--stroke);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: fixed; /* Changed from relative */
        top: 0;
        right: 0; /* Position to the right */
        bottom: 0;
        z-index: 1000; /* Higher z-index to overlay content */
        transition: transform 0.3s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
        transform: translateX(100%); /* Start collapsed by default */
        box-shadow: none; /* No shadow when collapsed */
      }
      
      .sidebar.collapsed {
        transform: translateX(100%); /* Fully hidden */
      }
      
      .sidebar:not(.collapsed) {
        transform: translateX(0%); /* Fully visible */
        box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5); /* Shadow when open */
      }
      
      @media (max-width: 768px) {
        .sidebar {
          width: 80%; /* Adjust width for smaller screens */
          max-width: 360px;
        }
      }
      
      .sidebar-header {
        padding: 16px;
        border-bottom: 1px solid var(--stroke);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .sidebar-header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      /* Language Toggle */
      .language-toggle {
        display: flex;
        align-items: center;
        margin-right: 8px;
      }

      .lang-toggle {
        position: relative;
        width: 50px;
        height: 24px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 2px;
        transition: all 0.3s ease;
        overflow: hidden;
      }

      .lang-toggle:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--stroke-hover);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }

      .lang-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 18px;
        height: 18px;
        background: var(--white-20);
        border: 1px solid var(--white-50);
        border-radius: 9px;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        color: var(--white);
      }

      .lang-toggle[data-lang="fa"] .lang-slider {
        transform: translateX(26px);
      }

      .lang-text {
        position: absolute;
        font-size: 9px;
        font-weight: 600;
        transition: opacity 0.2s ease;
        pointer-events: none;
      }

      .lang-text.en {
        left: 6px;
        opacity: 1;
        color: var(--white-60);
      }

      .lang-toggle[data-lang="fa"] .lang-text.en {
        opacity: 0.3;
      }

      .lang-text.fa {
        right: 6px;
        opacity: 0.3;
        color: var(--white-60);
      }

      .lang-toggle[data-lang="fa"] .lang-text.fa {
        opacity: 1;
      }
      
      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .logo-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--stroke);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      
      .logo h2 {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: -0.5px;
        color: var(--white);
      }
      
      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 0; /* Remove padding here, it's now inside sections */
      }
      
      .sidebar-content::-webkit-scrollbar {
        width: 6px;
      }
      
      .sidebar-content::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .sidebar-content::-webkit-scrollbar-thumb {
        background: var(--white-20);
        border-radius: 3px;
      }
      
      .sidebar-content::-webkit-scrollbar-thumb:hover {
        background: var(--white-30);
      }
      
      .section-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--white-60);
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      .form-group {
        margin-bottom: 14px;
      }
      
      .form-group label {
        display: block;
        font-size: 12px;
        color: var(--white-70);
        margin-bottom: 8px;
        font-weight: 500;
      }
      
      .input-glass {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--stroke);
        border-radius: 10px;
        color: var(--white);
        font-size: 13px;
        transition: all 0.3s ease;
        font-family: inherit;
      }
      
      .input-glass:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--white-50);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
      }
      
      .input-glass::placeholder {
        color: var(--white-40);
      }
      
      .input-hint {
        display: block;
        font-size: 11px;
        color: var(--white-50);
        margin-top: 6px;
      }
      
      .sidebar-content-wrapper {
        position: relative;
        height: calc(100% - 16px); /* Adjust for potential header/footer padding in sidebar */
        overflow: hidden;
      }
      
      .settings-section,
      .history-section {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        padding: 16px;
        overflow-y: auto;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }
      
      .settings-section {
        transform: translateX(-100%);
        opacity: 0;
        pointer-events: none;
      }
      
      .settings-section.active {
        transform: translateX(0%);
        opacity: 1;
        pointer-events: auto;
      }
      
      .history-section.active {
        transform: translateX(0%);
        opacity: 1;
        pointer-events: auto;
      }
      
      .history-section {
        transform: translateX(0%);
        opacity: 1;
        pointer-events: auto;
      }
      
      .history-section:not(.active) {
        transform: translateX(100%);
        opacity: 0;
        pointer-events: none;
      }
      
      .chat-sessions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: calc(100% - 40px); /* Adjust based on section-title height */
        overflow-y: auto;
        transition: gap 0.3s ease;
      }
      
      .chat-sessions:hover {
        transition: gap 0.3s ease;
        gap: 12px;
      }
      
      .chat-sessions:hover .session-item {
        transition: all 0.3s ease;
        transform: scale(0.98);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      
      
      .session-item {
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--stroke);
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        gap: 12px;
      }
      
      .chat-sessions .session-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--stroke-hover);
        transform: scale3d(0.98, 0.98, 0.98);
        transition: all 0.3s ease;
        gap: 10px;
      }
      
      .session-item.active {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--white-50);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      }
      
      .session-name {
        flex: 1;
        font-size: 13px;
        color: var(--white-80);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .session-item.active .session-name {
        color: var(--white);
        font-weight: 500;
      }
      
      .session-actions {
        display: flex;
        gap: 4px;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .session-item:hover .session-actions {
        opacity: 1;
      }
      
      .btn-edit-session,
      .btn-delete-session {
        background: transparent;
        border: none;
        color: var(--white-50);
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        border-radius: 4px;
      }
      
      .btn-edit-session:hover,
      .btn-delete-session:hover {
        color: var(--white);
        background: rgba(255, 255, 255, 0.1);
      }
      
      .session-name[contenteditable="true"] {
        outline: 1px solid var(--white-30);
        outline-offset: 2px;
        border-radius: 4px;
        padding: 2px 4px;
        background: rgba(255, 255, 255, 0.05);
      }
      
      /* Buttons */
      .btn-glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--stroke);
        border-radius: 10px;
        color: var(--white-80);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        padding: 10px;
      }
      
      .btn-glass:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--stroke-hover);
        color: var(--white);
        transform: translateY(-1px);
      }
      
      .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
      }
      
      /* Main Chat Area */
      .chat-main {
        top: 0;
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-black);
        overflow: hidden;
        position: relative; /* Added relative positioning */
        z-index: 1;
        transition: margin-right 0.3s ease;
        width: 100%;
        margin-right: 0;
      }
      
      
      .chat-header {
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        transition: padding-right 0.3s ease;
      }
      
      .app-container:not(:has(.sidebar.collapsed)) .chat-header {
        padding-right: 380px; /* Adjust for open sidebar width + padding */
      }
      
      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .header-title h1 {
        font-size: 24px;
        font-weight: 600;
        color: var(--white);
        margin-bottom: 4px;
        letter-spacing: -0.5px;
        text-shadow: 5px 0 10px rgba(0, 0, 0, 0.8);
      }
      
      .header-subtitle {
        font-size: 13px;
        color: var(--white-60);
        text-shadow: 5px 0 10px rgba(0, 0, 0, 0.8);
      }
      
      .header-actions {
        display: flex;
        gap: 8px;
      }
      
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        padding-bottom: var(--chat-input-height); /* Add padding to prevent overlap with input */
        padding-top: 90px; /* Add padding to prevent overlap with input */
        display: flex;
        flex-direction: column;
        gap: 16px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      
      .chat-messages::-webkit-scrollbar {
        width: 8px;
      }
      
      .chat-messages::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .chat-messages::-webkit-scrollbar-thumb {
        background: var(--white-20);
        border-radius: 4px;
      }
      
      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--white-30);
      }
      
      /* Welcome Message */
      .welcome-message {
        text-align: center;
        padding: 80px 20px;
        max-width: 700px;
        margin: auto;
      }
      
      .welcome-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        color: var(--white-60);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .welcome-message h2 {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--white);
        letter-spacing: -1px;
      }
      
      .welcome-message p {
        font-size: 16px;
        color: var(--white-70);
        margin-bottom: 40px;
        line-height: 1.6;
      }
      
      .example-prompts {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 450px;
        margin: 0 auto;
      }
      
      .example-prompt {
        padding: 16px 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 14px;
        color: var(--white-80);
        border-radius: 12px;
      }
      
      .example-prompt:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }
      
      .example-prompt span {
        display: block;
      }
      
      /* Messages */
      .message {
        display: flex;
        gap: 16px;
        animation: fadeIn 0.4s ease-out;
        max-width: 85%;
        margin-left: 12%;
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .message.user {
        flex-direction: row-reverse;
        margin-left: 2%;
        margin-right: auto;
      }
      
      .message-content {
        position: relative; /* Needed for absolute positioning of copy button */
        flex: 1;
      }
      
      .btn-copy-message {
        position: absolute;
        top: 80%; /* Adjust as needed */
        left: -30px; /* Adjust as needed */
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid var(--stroke);
        border-radius: 8px;
        color: var(--white-60);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        transition: all 0.2s ease;
        opacity: 0;
        visibility: hidden;
      }

      .btn-copy-code {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid var(--stroke);
        border-radius: 8px;
        color: var(--white-60);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        transition: all 0.2s ease;
        opacity: 0.7;
      }

      .btn-copy-code:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--stroke-hover);
        color: var(--white);
        transform: scale(1.05);
      }
      
      .message-content:hover .btn-copy-message {
        opacity: 1;
        visibility: visible;
        left: -48px; /* Slight movement on hover */
      }
      
      .btn-copy-message:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--stroke-hover);
        color: var(--white);
      }
      
      .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--stroke);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      
      .message.user .message-avatar {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--white-30);
      }
      
      .message-bubble {
        padding: 16px 20px;
        border-radius: 16px;
        word-wrap: break-word;
        line-height: 2;
        font-size: 14px;
      }
      
      .message.user .message-bubble {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--stroke);
        color: var(--white);
        border-top-left-radius: 4px;
      }
      
      .message.assistant .message-bubble {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--stroke);
        color: var(--white-90);
        border-bottom-left-radius: 4px;
      }
      
      /* Assistant Output */
      .assistant-output {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      .output-section {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        padding: 16px;
        transition: all 0.3s ease;
        margin-left: -12%;
      }
      
      .output-section:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--stroke-hover);
      }
      
      .output-section.collapsible {
        padding: 0;
        overflow: hidden;
      }
      
      .output-section.collapsible.collapsed .output-section-content {
        max-height: 0;
        padding: 0 16px;
        opacity: 0;
      }
      
      .output-section.collapsible:not(.collapsed) .output-section-content {
        max-height: 2000px;
        padding: 16px;
        opacity: 1;
        transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
      }
      
      .output-section-header {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
        position: relative;
      }
      
      .output-section-header:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      
      .output-section-header .collapse-icon {
        transition: transform 0.3s ease;
        color: var(--white-60);
      }
      
      .output-section.collapsed .output-section-header .collapse-icon {
        transform: rotate(-90deg);
      }
      
      .output-section-content {
        transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
        overflow: hidden;
      }
      
      .output-section-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--white-70);
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      .output-section-content {
        color: var(--white-90);
      }
      
      .output-image {
        max-width: 300px;
        width: 100%;
        height: auto;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.02);
        display: block;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .output-image:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
      }
      
      .output-code {
        background: rgba(0, 0, 0, 0.4);
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        overflow-x: auto;
        font-family: 'Courier New', 'Monaco', monospace;
        font-size: 13px;
        line-height: 1.6;
        direction: ltr;
        color: var(--white-90);
      }
      
      .output-code pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      
      .output-text {
        white-space: pre-wrap;
        line-height: 1.7;
        font-size: 14px;
        color: var(--white-80);
        direction: ltr;
      }
      
      /* Circuit Simulation Styles */
      .circuit-simulation-container {
        height: 100%;
        overflow-y: auto;
      }

      .simulation-main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        flex: 1;
        min-height: 600px;
      }

      .simulation-left-panel,
      .simulation-right-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .simulation-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .analysis-controls {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--stroke);
        border-radius: 8px;
        padding: 16px;
      }

      .netlist-editor {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--stroke);
        border-radius: 8px;
        color: var(--white-90);
        font-family: 'Courier New', monospace;
        font-size: 13px;
        padding: 16px;
        resize: vertical;
        outline: none;
        line-height: 1.6;
        transition: all 0.3s ease;
      }

      .netlist-editor:focus {
        border-color: var(--white-50);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
      }

      .exit-simulation-btn {
        background: rgba(255, 107, 107, 0.1) !important;
        border-color: rgba(255, 107, 107, 0.3) !important;
        color: #ff6b6b !important;
      }

      .exit-simulation-btn:hover {
        background: rgba(255, 107, 107, 0.2) !important;
        border-color: rgba(255, 107, 107, 0.5) !important;
        color: #ff6b6b !important;
      }

      /* Hide chat-only elements in simulation mode */
      .circuit-simulation-container .chat-only {
        display: none !important;
      }

      /* Chat Input */
      .chat-input-container {
        position: absolute; /* Changed to absolute */
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10; /* Higher z-index */
        padding: 16px 24px;
        max-width: 80%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: padding-right 0.3s ease;
      }
      
      .app-container:not(:has(.sidebar.collapsed)) .chat-input-container {
        padding-right: 380px; /* Adjust for open sidebar width + padding */
      }
      
      .input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        padding: 16px;
        transition: all 0.3s ease;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.05); /* Liquid glass background */
        backdrop-filter: blur(0.5px);
        -webkit-backdrop-filter: blur(0.5px);
        border: 1px solid var(--stroke);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); /* Depth shadow */
        width: 100%;
        margin-left: -25%;
      }
      
      .input-wrapper:focus-within {
        border-color: var(--white-50);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
        background: rgba(7, 7, 7, 0.5); /* Slightly brighter on focus */
        border-radius: 14px; /* Ensure consistent border-radius */
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }
      
      
      #chatInput {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--white);
        font-size: 15px;
        font-family: inherit;
        resize: none;
        max-height: 150px;
        overflow-y: auto;
        outline: none;
        line-height: 1.6;
      }
      
      #chatInput::placeholder {
        color: var(--white-40);
      }
      
      #chatInput::-webkit-scrollbar {
        width: 6px;
      }
      
      #chatInput::-webkit-scrollbar-track {
        background: transparent;
      }
      
      #chatInput::-webkit-scrollbar-thumb {
        background: var(--white-20);
        border-radius: 3px;
      }
      
      .btn-send {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--stroke);
        color: var(--white);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
      }
      
      .btn-send:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--white-50);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .btn-send:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      
      .status-message {
        display: none;
      }
      
      /* Toast Notification */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 50%;
        transform: translateX(50%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
        max-width: 90vw;
      }
      
      .toast {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        padding: 14px 20px;
        color: var(--white);
        font-size: 14px;
        min-width: 300px;
        max-width: 500px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        animation: toastSlideIn 0.3s ease-out;
        pointer-events: auto;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .toast.success {
        border-color: rgba(68, 255, 68, 0.3);
        background: rgba(68, 255, 68, 0.1);
      }
      
      .toast.error {
        border-color: rgba(255, 68, 68, 0.3);
        background: rgba(255, 68, 68, 0.1);
      }
      
      .toast.info {
        border-color: rgba(68, 136, 255, 0.3);
        background: rgba(68, 136, 255, 0.1);
      }
      
      @keyframes toastSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .toast-close {
        margin-right: auto;
        background: transparent;
        border: none;
        color: var(--white-70);
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
      }
      
      .toast-close:hover {
        color: var(--white);
        background: rgba(255, 255, 255, 0.1);
      }
      
      .status-message.error {
        color: #ff4444;
      }
      
      .status-message.success {
        color: #44ff44;
      }
      
      /* Loading */
      .loading {
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }
      
      .loading-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--white-60);
        animation: bounce 1.4s infinite ease-in-out both;
      }
      
      .loading-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      
      .loading-dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      
      @keyframes bounce {
        0%, 80%, 100% {
          transform: scale(0);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }
      
      /* Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          width: 300px;
        }
      }
      
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }
      
        .sidebar {
          width: 100%;
          max-height: 50vh;
          border-left: none;
          border-bottom: 1px solid var(--stroke);
        }
      
        .message {
          max-width: 95%;
        }
      
        .chat-header {
          padding: 20px;
        }
      
        .chat-messages {
          padding: 20px;
        }
      
        .chat-input-container {
          padding: 20px;
        }
      }
      
      .hidden {
        display: none !important;
      }
      
      .chat-sessions::-webkit-scrollbar {
        width: 6px;
      }
      
      .chat-sessions::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .chat-sessions::-webkit-scrollbar-thumb {
        background: var(--white-20);
        border-radius: 3px;
      }
      
      .chat-sessions::-webkit-scrollbar-thumb:hover {
        background: var(--white-30);
      }
    
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: var(--bg-black);
        padding: 20px;
    }
    .login-form {
        background: rgba(10, 10, 10, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--stroke);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        padding: 40px;
        width: 100%;
        max-width: 400px;
        text-align: center;
        animation: fadeInScale 0.5s ease-out;
    }
    @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
    }
    .login-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--white);
        margin-bottom: 30px;
        letter-spacing: -0.8px;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    }
    .login-form .form-group {
        margin-bottom: 20px;
        text-align: right;
    }
    .login-form label {
        font-size: 13px;
        color: var(--white-60);
        margin-bottom: 8px;
        font-weight: 500;
        display: block;
    }
    .login-form .input-glass {
        width: 100%;
        padding: 14px 18px;
        font-size: 14px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.04);
        border-color: var(--stroke);
    }
    .login-form .input-glass:focus {
        background: rgba(255, 255, 255, 0.07);
        border-color: var(--white-40);
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.08);
    }
    .login-button {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        margin-top: 20px;
        background: var(--white-10);
        border: 1px solid var(--white-30);
        color: var(--white);
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .login-button:hover {
        background: var(--white-20);
        border-color: var(--white-50);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    .login-form .error-message {
        color: #ff6b6b;
        font-size: 12px;
        margin-top: 10px;
        text-align: center;
    }
    .login-links {
        margin-top: 25px;
        font-size: 13px;
    }
    .login-links a {
        color: var(--white-60);
        text-decoration: none;
        transition: color 0.3s ease;
    }
    .login-links a:hover {
        color: var(--white);
        text-decoration: underline;
    }
    .login-links span {
        color: var(--white-40);
        margin: 0 5px;
    }
    .google-signup-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        margin-bottom: 20px;
        background: #ffffff;
        color: #333333;
        text-decoration: none;
        border: 1px solid #dadce0;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .google-signup-btn:hover {
        background: #f8f9fa;
        border-color: #c4c4c4;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    .google-signup-btn svg {
        flex-shrink: 0;
    }
    .divider {
        position: relative;
        text-align: center;
        margin: 20px 0;
        color: var(--white-50);
        font-size: 14px;
    }
    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--stroke);
    }
    .divider span {
        background: var(--bg-black);
        padding: 0 16px;
        position: relative;
        z-index: 1;
    }

    



    /* New styles for Circuit Design */


    :root {
      --bg-black: #000000;
      --bg-dark: #0a0a0a;
      --bg-darker: #050505;
      --white: #ffffff;
      --white-90: rgba(255, 255, 255, 0.9);
      --white-80: rgba(255, 255, 255, 0.8);
      --white-70: rgba(255, 255, 255, 0.7);
      --white-60: rgba(255, 255, 255, 0.6);
      --white-50: rgba(255, 255, 255, 0.5);
      --white-40: rgba(255, 255, 255, 0.4);
      --white-30: rgba(255, 255, 255, 0.3);
      --white-20: rgba(255, 255, 255, 0.2);
      --white-10: rgba(255, 255, 255, 0.1);
      --white-5: rgba(255, 255, 255, 0.05);
      --stroke: rgba(255, 255, 255, 0.15);
      --stroke-hover: rgba(255, 255, 255, 0.3);
      --glow: rgba(255, 255, 255, 0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Vazirmatn', 'IRANSans', sans-serif;
      background: var(--bg-black);
      color: var(--white);
      height: auto;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      direction: rtl;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      scroll-behavior: smooth;
    }
  
    /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø±ÙˆØ§Ù† Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ */
    html {
      scroll-behavior: smooth;
    }
  
    /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø±Ø§ÛŒ ÙˆØ¨â€ŒÚ©ÛŒØª (Safari, Chrome, Edge) */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
  
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
  
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      transition: background 0.3s ease;
    }
  
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
  
    /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05);
    }
    
    /* Glass Effect */
    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--stroke);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .glass-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--stroke-hover);
    }
    
    /* App Container session */
    .app-container {
      display: flex;
      height: auto;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      background: var(--bg-black);
      position: relative;
      width: 100%;
      --chat-header-height: 70px; /* Approximate height of chat-header */
      --chat-input-height: 120px; /* Approximate height of chat-input-container */
    }
     
    .app-container.login-page {
      display: block;
      justify-content: unset;
      align-items: unset;
      height: auto;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      overflow-y: auto;
    }
  
    .app-container::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.02) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    /* Sidebar */
    .sidebar {
      width: 360px;
      background: rgba(10, 10, 10, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid var(--stroke);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: fixed; /* Changed from relative */
      top: 0;
      right: 0; /* Position to the right */
      bottom: 0;
      z-index: 1000; /* Higher z-index to overlay content */
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
      transform: translateX(100%); /* Start collapsed by default */
      box-shadow: none; /* No shadow when collapsed */
    }
    
    .sidebar.collapsed {
      transform: translateX(100%); /* Fully hidden */
    }
    
    .sidebar:not(.collapsed) {
      transform: translateX(0%); /* Fully visible */
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5); /* Shadow when open */
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 80%; /* Adjust width for smaller screens */
        max-width: 360px;
      }
    }
    
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--stroke);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-header-actions {
      display: flex;
      gap: 8px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .logo h2 {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.5px;
      color: var(--white);
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 0; /* Remove padding here, it's now inside sections */
    }
    
    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--white-20);
      border-radius: 3px;
    }
    
    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--white-30);
    }
    
    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--white-60);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .form-group {
      margin-bottom: 14px;
    }
    
    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--white-70);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .input-glass {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--stroke);
      border-radius: 10px;
      color: var(--white);
      font-size: 13px;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    .input-glass:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--white-50);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
    }
    
    .input-glass::placeholder {
      color: var(--white-40);
    }
    
    .input-hint {
      display: block;
      font-size: 11px;
      color: var(--white-50);
      margin-top: 6px;
    }
    
    .sidebar-content-wrapper {
      position: relative;
      height: calc(100% - 16px); /* Adjust for potential header/footer padding in sidebar */
      overflow: hidden;
    }
    
    .settings-section,
    .history-section {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 16px;
      overflow-y: auto;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .settings-section {
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
    }
    
    .settings-section.active {
      transform: translateX(0%);
      opacity: 1;
      pointer-events: auto;
    }
    
    .history-section.active {
      transform: translateX(0%);
      opacity: 1;
      pointer-events: auto;
    }
    
    .history-section {
      transform: translateX(0%);
      opacity: 1;
      pointer-events: auto;
    }
    
    .history-section:not(.active) {
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    .chat-sessions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: calc(100% - 40px); /* Adjust based on section-title height */
      overflow-y: auto;
      transition: gap 0.3s ease;
    }
    
    .chat-sessions:hover {
      transition: gap 0.3s ease;
      gap: 12px;
    }
    
    .chat-sessions:hover .session-item {
      transition: all 0.3s ease;
      transform: scale(0.98);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    
    
    .session-item {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--stroke);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      gap: 12px;
    }
    
    .chat-sessions .session-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--stroke-hover);
      transform: scale3d(0.98, 0.98, 0.98);
      transition: all 0.3s ease;
      gap: 10px;
    }
    
    .session-item.active {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--white-50);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    }
    
    .session-name {
      flex: 1;
      font-size: 13px;
      color: var(--white-80);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .session-item.active .session-name {
      color: var(--white);
      font-weight: 500;
    }
    
    .session-actions {
      display: flex;
      gap: 4px;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .session-item:hover .session-actions {
      opacity: 1;
    }
    
    .btn-edit-session,
    .btn-delete-session {
      background: transparent;
      border: none;
      color: var(--white-50);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      border-radius: 4px;
    }
    
    .btn-edit-session:hover,
    .btn-delete-session:hover {
      color: var(--white);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .session-name[contenteditable="true"] {
      outline: 1px solid var(--white-30);
      outline-offset: 2px;
      border-radius: 4px;
      padding: 2px 4px;
      background: rgba(255, 255, 255, 0.05);
    }
    
    /* Buttons */
    .btn-glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--stroke);
      border-radius: 10px;
      color: var(--white-80);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      padding: 10px;
    }
    
    .btn-glass:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--stroke-hover);
      color: var(--white);
      transform: translateY(-1px);
    }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
    }
    
    /* Main Chat Area */
    .chat-main {
      top: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-black);
      overflow: hidden;
      position: relative; /* Added relative positioning */
      z-index: 1;
      transition: margin-right 0.3s ease;
      width: 100%;
      margin-right: 0;
    }
    
    
    .chat-header {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      transition: padding-right 0.3s ease;
    }
    
    .app-container:not(:has(.sidebar.collapsed)) .chat-header {
      padding-right: 380px; /* Adjust for open sidebar width + padding */
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .header-title h1 {
      font-size: 24px;
      font-weight: 600;
      color: var(--white);
      margin-bottom: 4px;
      letter-spacing: -0.5px;
      text-shadow: 5px 0 10px rgba(0, 0, 0, 0.8);
    }
    
    .header-subtitle {
      font-size: 13px;
      color: var(--white-60);
      text-shadow: 5px 0 10px rgba(0, 0, 0, 0.8);
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: var(--chat-input-height); /* Add padding to prevent overlap with input */
      padding-top: 90px; /* Add padding to prevent overlap with input */
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--white-20);
      border-radius: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--white-30);
    }
    
    /* Welcome Message */
    .welcome-message {
      text-align: center;
      padding: 80px 20px;
      max-width: 700px;
      margin: auto;
    }
    
    .welcome-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      color: var(--white-60);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .welcome-message h2 {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--white);
      letter-spacing: -1px;
    }
    
    .welcome-message p {
      font-size: 16px;
      color: var(--white-70);
      margin-bottom: 40px;
      line-height: 1.6;
    }
    
    .example-prompts {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 450px;
      margin: 0 auto;
    }
    
    .example-prompt {
      padding: 16px 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-size: 14px;
      color: var(--white-80);
      border-radius: 12px;
    }
    
    .example-prompt:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .example-prompt span {
      display: block;
    }
    
    /* Messages */
    .message {
      display: flex;
      gap: 16px;
      animation: fadeIn 0.4s ease-out;
      max-width: 85%;
      margin-left: 12%;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.user {
      flex-direction: row-reverse;
      margin-left: 2%;
      margin-right: auto;
    }
    
    .message-content {
      position: relative; /* Needed for absolute positioning of copy button */
      flex: 1;
    }
    
    .btn-copy-message {
      position: absolute;
      top: 80%; /* Adjust as needed */
      left: -30px; /* Adjust as needed */
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      color: var(--white-60);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      transition: all 0.2s ease;
      opacity: 0;
      visibility: hidden;
    }
    
    .message-content:hover .btn-copy-message {
      opacity: 1;
      visibility: visible;
      left: -48px; /* Slight movement on hover */
    }
    
    .btn-copy-message:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--stroke-hover);
      color: var(--white);
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .message.user .message-avatar {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--white-30);
    }
    
    .message-bubble {
      padding: 16px 20px;
      border-radius: 16px;
      word-wrap: break-word;
      line-height: 2;
      font-size: 14px;
    }
    
    .message.user .message-bubble {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--stroke);
      color: var(--white);
      border-top-left-radius: 4px;
    }
    
    .message.assistant .message-bubble {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--stroke);
      color: var(--white-90);
      border-bottom-left-radius: 4px;
    }
    
    /* Assistant Output */
    .assistant-output {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 40px;
      align-items: start; /* Align items to the start of the grid area */
    }
    
    .output-section {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s ease;
      margin-left: -7%;
    }
    
    .output-section:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--stroke-hover);
    }
    
    .output-section.collapsible {
      padding: 0;
      overflow: hidden;
    }
    
    .output-section.collapsible.collapsed .output-section-content {
      max-height: 0;
      padding: 0 16px;
      opacity: 0;
    }
    
    .output-section.collapsible:not(.collapsed) .output-section-content {
      max-height: 2000px;
      padding: 16px;
      opacity: 1;
      transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
    }
    
    .output-section-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    
    .output-section-header:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .output-section-header .collapse-icon {
      transition: transform 0.3s ease;
      color: var(--white-60);
    }
    
    .output-section.collapsed .output-section-header .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .output-section-content {
      transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
      overflow: hidden;
    }
    
    .output-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--white-70);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .output-section-content {
      color: var(--white-90);
    }
    
    .output-image {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.02);
      display: block;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
  
    .circuit-image-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
  
    .image-button-container {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
  
    .image-action-btn {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 500;
    }
  
    .image-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
  
    .output-code {
      background: rgba(0, 0, 0, 0.4);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      overflow-x: auto;
      font-family: 'Courier New', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
      direction: ltr;
      color: var(--white-90);
    }
    
    .output-code pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .output-text {
      white-space: pre-wrap;
      line-height: 1.7;
      font-size: 14px;
      color: var(--white-80);
      direction: ltr;
    }
    
    /* Chat Input */
    .chat-input-container {
      position: absolute; /* Changed to absolute */
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10; /* Higher z-index */
      padding: 16px 24px;
      max-width: 80%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: padding-right 0.3s ease;
    }
    
    .app-container:not(:has(.sidebar.collapsed)) .chat-input-container {
      padding-right: 380px; /* Adjust for open sidebar width + padding */
    }
    
    .input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      padding: 16px;
      transition: all 0.3s ease;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.05); /* Liquid glass background */
      backdrop-filter: blur(0.5px);
      -webkit-backdrop-filter: blur(0.5px);
      border: 1px solid var(--stroke);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); /* Depth shadow */
      width: 100%;
      margin-left: -25%;
    }
    
    .input-wrapper:focus-within {
      border-color: var(--white-50);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
      background: rgba(7, 7, 7, 0.5); /* Slightly brighter on focus */
      border-radius: 14px; /* Ensure consistent border-radius */
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    
    
    #chatInput {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--white);
      font-size: 15px;
      font-family: inherit;
      resize: none;
      max-height: 150px;
      overflow-y: auto;
      outline: none;
      line-height: 1.6;
    }
    
    #chatInput::placeholder {
      color: var(--white-40);
    }
    
    #chatInput::-webkit-scrollbar {
      width: 6px;
    }
    
    #chatInput::-webkit-scrollbar-track {
      background: transparent;
    }
    
    #chatInput::-webkit-scrollbar-thumb {
      background: var(--white-20);
      border-radius: 3px;
    }
    
    #chatInput::-webkit-scrollbar-thumb:hover {
      background: var(--white-30);
    }
    
    .btn-send {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--stroke);
      color: var(--white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .btn-send:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--white-50);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .btn-send:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .status-message {
      display: none;
    }
    
    /* Toast Notification */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 50%;
      transform: translateX(50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
      max-width: 90vw;
    }
    
    .toast {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 14px 20px;
      color: var(--white);
      font-size: 14px;
      min-width: 300px;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      animation: toastSlideIn 0.3s ease-out;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .toast.success {
      border-color: rgba(68, 255, 68, 0.3);
      background: rgba(68, 255, 68, 0.1);
    }
    
    .toast.error {
      border-color: rgba(255, 68, 68, 0.3);
      background: rgba(255, 68, 68, 0.1);
    }
    
    .toast.info {
      border-color: rgba(68, 136, 255, 0.3);
      background: rgba(68, 136, 255, 0.1);
    }
    
    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .toast-close {
      margin-right: auto;
      background: transparent;
      border: none;
      color: var(--white-70);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .toast-close:hover {
      color: var(--white);
      background: rgba(255, 255, 255, 0.1);
    }
    
    .status-message.error {
      color: #ff4444;
    }
    
    .status-message.success {
      color: #44ff44;
    }
    
    /* Loading */
    .loading {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    
    .loading-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--white-60);
      animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .loading-dot:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .loading-dot:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        width: 300px;
      }
    }
    
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
    
      .sidebar {
        width: 100%;
        max-height: 50vh;
        border-left: none;
        border-bottom: 1px solid var(--stroke);
      }
    
      .message {
        max-width: 95%;
      }
    
      .chat-header {
        padding: 20px;
      }
    
      .chat-messages {
        padding: 20px;
      }
    
      .chat-input-container {
        padding: 20px;
      }
    }
    
    .hidden {
      display: none !important;
    }
    
    .chat-sessions::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-sessions::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-sessions::-webkit-scrollbar-thumb {
      background: var(--white-20);
      border-radius: 3px;
    }
    
    .chat-sessions::-webkit-scrollbar-thumb:hover {
      background: var(--white-30);
    }
  
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--bg-black);
      padding: 20px;
  }
  .login-form {
      background: rgba(10, 10, 10, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      animation: fadeInScale 0.5s ease-out;
  }
  @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
  }
  .login-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 30px;
      letter-spacing: -0.8px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
  }
  .login-form .form-group {
      margin-bottom: 20px;
      text-align: right;
  }
  .login-form label {
      font-size: 13px;
      color: var(--white-60);
      margin-bottom: 8px;
      font-weight: 500;
      display: block;
  }
  .login-form .input-glass {
      width: 100%;
      padding: 14px 18px;
      font-size: 14px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      border-color: var(--stroke);
  }
  .login-form .input-glass:focus {
      background: rgba(255, 255, 255, 0.07);
      border-color: var(--white-40);
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.08);
  }
  .login-button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      margin-top: 20px;
      background: var(--white-10);
      border: 1px solid var(--white-30);
      color: var(--white);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  .login-button:hover {
      background: var(--white-20);
      border-color: var(--white-50);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }
  .login-form .error-message {
      color: #ff6b6b;
      font-size: 12px;
      margin-top: 10px;
      text-align: center;
  }
  .login-links {
      margin-top: 25px;
      font-size: 13px;
  }
  .login-links a {
      color: var(--white-60);
      text-decoration: none;
      transition: color 0.3s ease;
  }
  .login-links a:hover {
      color: var(--white);
      text-decoration: underline;
  }
  .login-links span {
      color: var(--white-40);
      margin: 0 5px;
  }
  
  /* Google Sign-In Styles */
  #google-accounts-container {
      margin: 20px 0;
  }
  
  .google-account-select-btn,
  .google-signin-btn {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
      color: var(--white);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
  }
  
  .google-account-select-btn:hover,
  .google-signin-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--stroke-hover);
      transform: translateY(-1px);
  }
  
  .google-account-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
  }
  
  .google-account-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--stroke-hover);
  }
  
  .account-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
  }
  
  .account-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  
  .account-info {
      flex: 1;
      text-align: right;
  }
  
  .account-name {
      color: var(--white);
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 2px;
  }
  
  .account-email {
      color: var(--white-60);
      font-size: 12px;
  }
  
  .account-actions {
      flex-shrink: 0;
  }
  
  .account-action-btn {
      background: var(--accent);
      border: none;
      color: white;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
  }
  
  .account-action-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
  }
  
  .sign-out-btn {
      background: rgba(255, 68, 68, 0.2);
      color: #ff6b6b;
  }
  
  .sign-out-btn:hover {
      background: rgba(255, 68, 68, 0.3);
  }
  
  .google-signin-prompt {
      text-align: center;
      padding: 20px;
      color: var(--white-70);
  }
  
  .google-signin-prompt p {
      margin-bottom: 16px;
      font-size: 14px;
  }
  
  .google-account-prompt {
      margin-top: 15px;
  }
  
  .google-account-select-btn {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
      color: var(--white);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
  }
  
  .google-account-select-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--stroke-hover);
      transform: translateY(-1px);
  }
  
  .google-welcome-message {
      background: rgba(40, 167, 69, 0.1);
      border: 1px solid rgba(40, 167, 69, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
  }
  
  .welcome-content {
      display: flex;
      align-items: center;
      gap: 12px;
  }
  
  .welcome-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
  }
  
  .welcome-text {
      text-align: right;
      flex: 1;
  }
  
  .welcome-name {
      color: var(--white);
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 2px;
  }
  
  .welcome-email {
      color: var(--white-60);
      font-size: 12px;
  }
  
  .google-error-message {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid rgba(255, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
  }
  
  .error-content {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #ff6b6b;
  }
  
  .error-icon {
      font-size: 16px;
  }
  
  .error-text {
      font-size: 14px;
  }
  
  /* Responsive adjustments for Google components */
  @media (max-width: 480px) {
      .google-account-card,
      .google-account-select-btn,
      .google-signin-btn {
          padding: 12px;
          font-size: 13px;
      }
  
      .account-avatar,
      .welcome-avatar {
          width: 36px;
          height: 36px;
      }
  
      .account-name,
      .welcome-name {
          font-size: 13px;
      }
  
      .account-email,
      .welcome-email {
          font-size: 11px;
      }
  }
  
  /* New styles for Circuit Design */
  .circuit-design-grid {
    display: grid;
    grid-template-columns: 1fr; /* Default to single column for smaller screens */
    gap: 20px;
    align-items: start;
  }
  
  @media (min-width: 768px) {
    .circuit-design-grid {
      grid-template-columns: 2fr 1fr; /* Two columns, left wider than right */
    }
  }
  
  .simulation-control-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 20px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--stroke);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
  }
  
  .simulation-control-panel:hover {
    border-color: var(--stroke-hover);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }
  
  .simulate-circuit-btn {
    padding: 16px 32px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 12px;
    margin-bottom: 8px;
    /* Inherits most styles from .btn-glass */
  }
  
  .simulate-circuit-btn:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  }
  
  .simulation-description {
    color: var(--white-60);
    font-size: 14px;
    line-height: 1.6;
    margin: 0;
  }
  
  .circuit-image-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    padding: 20px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--stroke);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
  }
  
  .circuit-image-container:hover {
    border-color: var(--stroke-hover);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }
  
  .output-image {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    border: 1px solid var(--stroke);
    transition: all 0.4s ease-in-out;
    cursor: zoom-in;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  }
  
  .output-image:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
  }
  
  .image-button-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  .image-action-btn {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 500;
    /* Inherits most styles from .btn-glass */
  }
  
  .image-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  @keyframes pulse { /* New animation for a subtle glow effect */
    0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.1); }
    70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
  }
  
  .output-section-header:hover .output-section-title {
    color: var(--white);
    transition: color 0.3s ease;
  }
  
  .output-section-header:hover .collapse-icon {
    color: var(--white);
    transform: rotate(0deg) scale(1.1);
    transition: transform 0.3s ease, color 0.3s ease;
  }
  
  .output-section.collapsed .output-section-header:hover .collapse-icon {
    transform: rotate(-90deg) scale(1.1);
  }
  
  
  
    </style>


  </body>



  
</html>



